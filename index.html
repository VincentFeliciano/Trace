<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg%20width%3D%2229%22%20height%3D%2233%22%20viewBox%3D%220%200%2029%2033%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Cpath%20d%3D%22M14.4088%200L28.8087%208.03863V24.1159L14.4088%2032.1545L0%2024.1159V8.03863L14.4088%200Z%22%20fill%3D%22%23FC6188%22%2F%3E%3Cpath%20d%3D%22M14.6623%2016.0365L0.156921%2024.0583L0.156922%208.01465L14.6623%2016.0365Z%22%20fill%3D%22%23E0115F%22%2F%3E%3Cpath%20d%3D%22M28.8087%208.03863L14.4089%2015.9957L14.4089%200L28.8087%208.03863Z%22%20fill%3D%22%23E0115F%22%2F%3E%3Cpath%20d%3D%22M28.8087%2024.1159L14.2226%2016.0346L28.8087%208.03864L28.8087%2024.1159Z%22%20fill%3D%22%23A00942%22%2F%3E%3Cpath%20d%3D%22M14.4088%2032.1545L14.329%2015.914L28.8086%2024.1159L14.4088%2032.1545Z%22%20fill%3D%22%23E0115F%22%2F%3E%3Cpath%20d%3D%22M14.4089%207.18172L22.6007%2011.7519V20.8923L14.4089%2025.4625L6.21705%2020.8923V11.7519L14.4089%207.18172Z%22%20fill%3D%22%23A00942%22%2F%3E%3Cpath%20d%3D%22M14.4088%2025.4625V7.18172L22.6011%2011.3847V20.8923L14.4088%2025.4625Z%22%20fill%3D%22%23FC6188%22%2F%3E%3C%2Fsvg%3E">
  <title>RUBY - Requests-Utilities-Builds-Yields</title>
  <style>
    /* Theme Variables */
    :root {
      /* Classic - Dark Blue (Default) */
      --bg-primary: #0a0e1a;
      --bg-secondary: #1a1f2e;
      --bg-tertiary: #252b3d;
      --bg-card: rgba(30, 35, 50, 0.6);
      --text-primary: #f0f0f0;
      --text-secondary: #a0a0a0;
      --text-muted: #707070;
      --border-color: rgba(255, 255, 255, 0.1);
      --accent-primary: #00d4ff;
      --accent-secondary: #0099cc;
      --ruby-accent: #e0115f;
    }
    
    [data-theme="ruby-noir"] {
      --bg-primary: #0d0d0d;
      --bg-secondary: #1a1a1a;
      --bg-tertiary: #2d2d2d;
      --bg-card: rgba(20, 20, 20, 0.6);
      --text-primary: #f0f0f0;
      --text-secondary: #a0a0a0;
      --text-muted: #707070;
      --border-color: rgba(255, 255, 255, 0.12);
      --accent-primary: #e0115f;
      --accent-secondary: #b00e4d;
      --ruby-accent: #e0115f;
    }
    
    [data-theme="ruby-twilight"] {
      --bg-primary: #0f0a1f;
      --bg-secondary: #1a1530;
      --bg-tertiary: #2d2548;
      --bg-card: rgba(26, 21, 48, 0.6);
      --text-primary: #e8e4f3;
      --text-secondary: #b8a8d8;
      --text-muted: #8878a8;
      --border-color: rgba(184, 168, 216, 0.15);
      --accent-primary: #a78bfa;
      --accent-secondary: #8b5cf6;
      --ruby-accent: #e0115f;
    }
    
    [data-theme="ruby-forest"] {
      --bg-primary: #0a1410;
      --bg-secondary: #152820;
      --bg-tertiary: #1f3d30;
      --bg-card: rgba(21, 40, 32, 0.6);
      --text-primary: #e4f3ea;
      --text-secondary: #8db89f;
      --text-muted: #5d8570;
      --border-color: rgba(141, 184, 159, 0.15);
      --accent-primary: #34d399;
      --accent-secondary: #10b981;
      --ruby-accent: #e0115f;
    }
    
    [data-theme="ruby-ocean"] {
      --bg-primary: #0a1628;
      --bg-secondary: #122340;
      --bg-tertiary: #1a3558;
      --bg-card: rgba(18, 35, 64, 0.6);
      --text-primary: #e4f0ff;
      --text-secondary: #8bb8e8;
      --text-muted: #5a8dc0;
      --border-color: rgba(139, 184, 232, 0.15);
      --accent-primary: #3b82f6;
      --accent-secondary: #2563eb;
      --ruby-accent: #e0115f;
    }
    
    [data-theme="ruby-ember"] {
      --bg-primary: #1a0f08;
      --bg-secondary: #2d1810;
      --bg-tertiary: #4a2818;
      --bg-card: rgba(45, 24, 16, 0.6);
      --text-primary: #ffe8dc;
      --text-secondary: #d8a890;
      --text-muted: #a87860;
      --border-color: rgba(216, 168, 144, 0.15);
      --accent-primary: #f59e0b;
      --accent-secondary: #d97706;
      --ruby-accent: #e0115f;
    }
    
    [data-theme="ruby-slate"] {
      --bg-primary: #0f1419;
      --bg-secondary: #1c2128;
      --bg-tertiary: #2d333b;
      --bg-card: rgba(28, 33, 40, 0.6);
      --text-primary: #e6edf3;
      --text-secondary: #9198a1;
      --text-muted: #636e7b;
      --border-color: rgba(145, 152, 161, 0.15);
      --accent-primary: #58a6ff;
      --accent-secondary: #1f6feb;
      --ruby-accent: #e0115f;
    }
    
    [data-theme="ruby-midnight"] {
      --bg-primary: #050a1f;
      --bg-secondary: #0d1530;
      --bg-tertiary: #182548;
      --bg-card: rgba(13, 21, 48, 0.6);
      --text-primary: #dce4ff;
      --text-secondary: #8893b8;
      --text-muted: #5862a0;
      --border-color: rgba(136, 147, 184, 0.15);
      --accent-primary: #60a5fa;
      --accent-secondary: #3b82f6;
      --ruby-accent: #e0115f;
    }
    
    [data-theme="ruby-crimson"] {
      --bg-primary: #1a0a0f;
      --bg-secondary: #2d1218;
      --bg-tertiary: #481d28;
      --bg-card: rgba(45, 18, 24, 0.6);
      --text-primary: #ffe4ea;
      --text-secondary: #d88898;
      --text-muted: #a85868;
      --border-color: rgba(216, 136, 152, 0.15);
      --accent-primary: #fb7185;
      --accent-secondary: #f43f5e;
      --ruby-accent: #e0115f;
    }
    
    [data-theme="ruby-cosmic"] {
      --bg-primary: #0f0a1a;
      --bg-secondary: #1a122d;
      --bg-tertiary: #2d1f48;
      --bg-card: rgba(26, 18, 45, 0.6);
      --text-primary: #e8dcff;
      --text-secondary: #b8a0d8;
      --text-muted: #8870a8;
      --border-color: rgba(184, 160, 216, 0.15);
      --accent-primary: #c084fc;
      --accent-secondary: #a855f7;
      --ruby-accent: #e0115f;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      overflow: hidden;
      background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
      color: var(--text-primary);
      height: 100vh;
      transition: background 0.3s ease, color 0.3s ease;
    }
    
    .trace-app {
      height: 100vh;
      display: flex;
      overflow: hidden;
    }
    
    /* Sidebar */
    .sidebar {
      width: 350px;
      background: var(--bg-tertiary);
      backdrop-filter: blur(20px);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .sidebar-header {
      padding: 16px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .logo {
display: flex;;
      letter-spacing: -0.5px;
      margin-bottom: 2px;
      text-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
    }
    
    .tagline {
      font-size: 10px;
      color: var(--text-muted);
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }
    
    .theme-selector {
      margin-top: 12px;
      position: relative;
    }
    
    .theme-btn {
      width: 100%;
      padding: 8px 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.2s;
    }
    
    .theme-btn:hover {
      background: var(--bg-card);
      border-color: var(--accent-primary);
    }
    
    .theme-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      margin-top: 4px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    }
    
    .theme-dropdown.visible {
      display: block;
    }
    
    .theme-option {
      padding: 10px 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all 0.2s;
      border-bottom: 1px solid var(--border-color);
    }
    
    .theme-option:last-child {
      border-bottom: none;
    }
    
    .theme-option:hover {
      background: var(--bg-card);
    }
    
    .theme-option.active {
      background: rgba(224, 17, 95, 0.1);
      border-left: 3px solid var(--ruby-accent);
    }
    
    .theme-color-preview {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 2px solid rgba(255, 255, 255, 0.2);
      flex-shrink: 0;
    }
    
    .theme-name {
      flex: 1;
      font-size: 12px;
      color: var(--text-primary);
    }
    
    .nav-section {
      padding: 12px;
      flex: 1;
      overflow-y: auto;
    }
    
    .nav-section h3 {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-muted);
      margin-bottom: 8px;
      margin-top: 16px;
      font-weight: 600;
    }
    
    .nav-section h3:first-child {
      margin-top: 0;
    }
    
    .nav-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 13px;
      margin-bottom: 2px;
    }
    
    .nav-item:hover {
      background: var(--border-color);
    }
    
    .nav-item.active {
      background: rgba(0, 212, 255, 0.1);
      color: var(--accent-primary);
    }
    
    .filter-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 12px;
      margin-bottom: 2px;
    }
    
    .filter-item:hover {
      background: rgba(255, 255, 255, 0.03);
    }
    
    .filter-item.active {
      background: rgba(100, 116, 139, 0.1);
      color: var(--text-primary);
    }
    
    .filter-label {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .filter-count {
      font-size: 10px;
      color: var(--text-muted);
      background: var(--border-color);
      padding: 2px 6px;
      border-radius: 10px;
    }
    
    .btn-primary {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px;
      background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
      border: none;
      border-radius: 8px;
      color: #0a0e1a;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.3s;
      margin: 12px;
      box-shadow: 0 4px 20px rgba(0, 212, 255, 0.3);
    }
    
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 25px rgba(0, 212, 255, 0.4);
    }
    
    .btn-secondary {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 16px;
      background: var(--border-color);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-secondary:hover {
      background: var(--border-color);
      border-color: rgba(255, 255, 255, 0.2);
    }
    
    /* Timeline View */
    .timeline-view {
      flex: 1;
      display: flex;
      overflow: hidden;
    }
    
    .timeline-list {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    
    .timeline-header {
      display: none;
    }
    
    .timeline-title {
      display: none;
    }
    
    .thread-banner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(135deg, rgba(0, 212, 255, 0.15), rgba(0, 153, 204, 0.1));
      border: 1px solid rgba(0, 212, 255, 0.3);
      border-radius: 8px;
      padding: 10px 12px;
      margin-bottom: 16px;
      animation: slideIn 0.3s ease-out;
    }
    
    .thread-banner-content {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .thread-banner-icon {
      font-size: 16px;
    }
    
    .thread-banner-text {
      font-size: 13px;
      font-weight: 600;
      color: var(--accent-primary);
    }
    
    .thread-banner-actions {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .thread-banner-btn {
      background: var(--border-color);
      border: none;
      border-radius: 4px;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 4px 8px;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    .thread-banner-btn:hover {
      background: rgba(255, 107, 107, 0.2);
      color: #ff6b6b;
    }
    
    .thread-banner-close {
      background: var(--border-color);
      border: none;
      border-radius: 4px;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 4px 8px;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    .thread-banner-close:hover {
      background: rgba(255, 255, 255, 0.2);
      color: var(--text-primary);
    }
    
    .moment-card {
      background: rgba(30, 41, 59, 0.4);
      backdrop-filter: blur(10px);
      border: 1px solid var(--border-color);
      border-left: 3px solid;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.3s;
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .moment-card:hover {
      background: rgba(30, 41, 59, 0.6);
      border-color: var(--border-color);
      transform: translateX(4px);
    }
    
    .moment-card.selected {
      border-left-width: 4px;
      background: rgba(30, 41, 59, 0.8);
    }
    
    .moment-thread-badge {
      display: inline-block;
      font-size: 10px;
      padding: 4px 8px;
      background: rgba(0, 212, 255, 0.15);
      border: 1px solid rgba(0, 212, 255, 0.3);
      border-radius: 4px;
      color: var(--accent-primary);
      margin-bottom: 8px;
      font-weight: 600;
    }
    
    .moment-unthreaded-badge {
      display: inline-block;
      font-size: 10px;
      padding: 4px 8px;
      background: rgba(100, 116, 139, 0.15);
      border: 1px solid rgba(100, 116, 139, 0.3);
      border-radius: 4px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      font-weight: 600;
    }
    
    .moment-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .moment-type {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .moment-time {
      font-size: 10px;
      color: var(--text-muted);
      font-family: 'Courier New', monospace;
    }
    
    /* SVG Icon Styles */
    .icon-moment,
    .icon-nav,
    .icon-priority,
    .icon-content,
    .icon-action,
    .icon-context {
      display: inline-block;
      vertical-align: middle;
      flex-shrink: 0;
    }
    
    .icon-moment {
      width: 16px;
      height: 16px;
    }
    
    .type-btn .icon-moment {
      width: 20px;
      height: 20px;
    }
    
    .detail-type-icon .icon-moment {
      width: 36px;
      height: 36px;
    }
    
    .graph-node .icon-moment {
      width: 16px;
      height: 16px;
    }
    
    .icon-nav {
      width: 16px;
      height: 16px;
      margin-right: 8px;
    }
    
    .icon-priority {
      width: 14px;
      height: 14px;
      margin-right: 4px;
    }
    
    .icon-content {
      width: 18px;
      height: 18px;
      margin-right: 6px;
    }
    
    .icon-action {
      width: 16px;
      height: 16px;
      margin-right: 6px;
    }
    
    .icon-context {
      width: 12px;
      height: 12px;
      margin-right: 4px;
    }
    
    .moment-text {
      font-size: 13px;
      line-height: 1.5;
      color: #cbd5e1;
      margin-bottom: 8px;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    
    /* Markdown Styles */
    .moment-text p,
    .detail-content p {
      margin: 0 0 8px 0;
    }
    
    .moment-text p:last-child,
    .detail-content p:last-child {
      margin-bottom: 0;
    }
    
    .moment-text strong,
    .detail-content strong {
      color: var(--accent-primary);
      font-weight: 600;
    }
    
    .moment-text em,
    .detail-content em {
      color: var(--text-primary);
      font-style: italic;
    }
    
    .moment-text code,
    .detail-content code {
      background: rgba(0, 0, 0, 0.4);
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: var(--accent-primary);
    }
    
    .moment-text pre,
    .detail-content pre {
      background: rgba(0, 0, 0, 0.4);
      padding: 12px;
      border-radius: 6px;
      overflow-x: auto;
      margin: 8px 0;
      border-left: 3px solid var(--accent-primary);
    }
    
    .moment-text pre code,
    .detail-content pre code {
      background: none;
      padding: 0;
      color: var(--text-primary);
    }
    
    .moment-text ul,
    .moment-text ol,
    .detail-content ul,
    .detail-content ol {
      margin: 8px 0;
      padding-left: 24px;
    }
    
    .moment-text li,
    .detail-content li {
      margin: 4px 0;
    }
    
    .moment-text blockquote,
    .detail-content blockquote {
      border-left: 3px solid var(--accent-primary);
      padding-left: 12px;
      margin: 8px 0;
      color: var(--text-secondary);
      font-style: italic;
    }
    
    .moment-text a,
    .detail-content a {
      color: var(--accent-primary);
      text-decoration: none;
      border-bottom: 1px solid transparent;
      transition: border-color 0.2s;
    }
    
    .moment-text a:hover,
    .detail-content a:hover {
      border-bottom-color: var(--accent-primary);
    }
    
    .wikilink {
      color: var(--ruby-accent) !important;
      font-weight: 500;
      border-bottom: 1px dashed var(--ruby-accent) !important;
      transition: all 0.2s;
    }
    
    .wikilink:hover {
      background: rgba(224, 17, 95, 0.1);
      border-bottom-style: solid !important;
    }
    
    .wikilink-missing {
      color: var(--text-muted);
      font-style: italic;
    }
    
    .moment-text h1,
    .moment-text h2,
    .moment-text h3,
    .moment-text h4,
    .detail-content h1,
    .detail-content h2,
    .detail-content h3,
    .detail-content h4 {
      color: var(--text-primary);
      margin: 12px 0 8px 0;
      font-weight: 600;
    }
    
    .moment-text h1,
    .detail-content h1 {
      font-size: 18px;
    }
    
    .moment-text h2,
    .detail-content h2 {
      font-size: 16px;
    }
    
    .moment-text h3,
    .detail-content h3 {
      font-size: 14px;
    }
    
    .moment-text h4,
    .detail-content h4 {
      font-size: 13px;
    }
    
    .moment-text hr,
    .detail-content hr {
      border: none;
      border-top: 1px solid var(--border-color);
      margin: 12px 0;
    }
    
    .moment-context {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }
    
    .context-tag {
      font-size: 10px;
      padding: 3px 8px;
      background: var(--border-color);
      border-radius: 10px;
      color: var(--text-secondary);
      font-family: 'Courier New', monospace;
    }
    
    .moment-charts {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 8px;
    }
    
    .moment-attachments {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    
    .attachment-preview {
      position: relative;
      width: 80px;
      height: 80px;
      border-radius: 6px;
      overflow: hidden;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--border-color);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .attachment-preview:hover {
      border-color: rgba(0, 212, 255, 0.5);
      transform: scale(1.05);
    }
    
    .attachment-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .attachment-file {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      font-size: 24px;
    }
    
    .attachment-preview-large {
      position: relative;
      margin-top: 8px;
      border-radius: 8px;
      overflow: hidden;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--border-color);
    }
    
    .attachment-preview-large img {
      width: 100%;
      max-height: 400px;
      object-fit: contain;
      display: block;
    }
    
    .attachment-remove {
      position: absolute;
      top: 4px;
      right: 4px;
      background: rgba(255, 107, 107, 0.9);
      color: white;
      border: none;
      border-radius: 4px;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
      z-index: 10;
    }
    
    .attachment-remove:hover {
      background: rgba(255, 107, 107, 1);
      transform: scale(1.1);
    }
    
    .attachments-container {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 12px;
    }
    
    .attachment-item {
      position: relative;
    }
    
    .moment-type-icon {
      font-size: 32px;
    }
    
    .chart-header {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    /* Detail Panel */
    .detail-panel {
      width: 450px;
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(20px);
      border-left: 1px solid var(--border-color);
      overflow-y: auto;
      padding: 16px;
      display: none;
    }
    
    .detail-panel.visible {
      display: block;
    }
    
    .detail-header {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .detail-type-icon {
      padding: 10px;
      border-radius: 8px;
      background: var(--border-color);
      font-size: 20px;
    }
    
    .detail-meta h2 {
      font-size: 14px;
      margin-bottom: 4px;
      color: var(--text-primary);
    }
    
    .detail-timestamp {
      font-size: 11px;
      color: var(--text-muted);
      font-family: 'Courier New', monospace;
    }
    
    .detail-content {
      font-size: 13px;
      line-height: 1.6;
      color: #cbd5e1;
      margin-bottom: 16px;
      word-wrap: break-word;
    }
    
    .detail-section {
      margin-bottom: 16px;
    }
    
    .detail-section h3 {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-muted);
      margin-bottom: 10px;
    }
    
    .context-grid {
      display: grid;
      gap: 12px;
    }
    
    .context-item {
      background: rgba(0, 0, 0, 0.2);
      padding: 12px;
      border-radius: 6px;
      border-left: 2px solid rgba(100, 116, 139, 0.3);
    }
    
    .context-item-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }
    
    .context-item-value {
      font-size: 13px;
      color: var(--text-primary);
      font-family: 'Courier New', monospace;
    }
    
    /* Capture View */
    .capture-view {
      flex: 1;
      padding: 16px 32px;
      overflow-y: auto;
      max-width: 1400px;
      width: 100%;
      margin: 0 auto;
      display: none;
    }
    
    .capture-view.visible {
      display: block;
    }
    
    .capture-header {
      margin-bottom: 16px;
    }
    
    .capture-header h1 {
      font-size: 24px;
      margin-bottom: 6px;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .capture-subtitle {
      font-size: 13px;
      color: var(--text-muted);
    }
    
    .capture-thread-indicator {
      margin-top: 12px;
      padding: 8px 12px;
      background: rgba(0, 212, 255, 0.15);
      border: 1px solid rgba(0, 212, 255, 0.3);
      border-radius: 6px;
      font-size: 12px;
      color: var(--accent-primary);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .type-selector {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    
    .type-btn {
      flex: 1;
      min-width: 100px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      padding: 12px;
      background: rgba(30, 41, 59, 0.4);
      border: 2px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .type-btn:hover {
      background: rgba(30, 41, 59, 0.6);
      border-color: var(--border-color);
    }
    
    .type-btn.active {
      border-color: currentColor;
      background: rgba(30, 41, 59, 0.8);
    }
    
    .type-btn-icon {
      font-size: 20px;
    }
    
    .type-btn-label {
      font-size: 12px;
      font-weight: 600;
    }
    
    .form-group {
      margin-bottom: 14px;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      align-items: start;
      margin-bottom: 14px;
    }
    
    .form-grid-full {
      grid-column: 1 / -1;
    }
    
    .form-label {
      display: block;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-muted);
      margin-bottom: 6px;
    }
    
    .form-textarea {
      width: 100%;
      min-height: 120px;
      padding: 12px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 14px;
      line-height: 1.5;
      resize: vertical;
      font-family: inherit;
    }
    
    .form-textarea:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
    }
    
    .form-input {
      width: 100%;
      padding: 10px 12px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 13px;
      font-family: 'Courier New', monospace;
    }
    
    .form-input:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
    }
    
    /* Select dropdown styling */
    select.form-input {
      cursor: pointer;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2300d4ff' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
    }
    
    select.form-input option {
      background: #1a1f2e;
      color: var(--text-primary);
      padding: 8px;
    }
    
    select.form-input:hover {
      border-color: rgba(0, 212, 255, 0.3);
    }
    
    .context-fields {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
    }
    
    .template-field {
      margin-bottom: 16px;
    }
    
    .template-field-label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: #cbd5e1;
      margin-bottom: 6px;
    }
    
    .template-field-textarea {
      width: 100%;
      min-height: 80px;
      padding: 10px 12px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 13px;
      line-height: 1.5;
      resize: vertical;
      font-family: inherit;
    }
    
    .template-field-textarea:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
    }
    
    .template-data-display {
      margin-top: 12px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      overflow: hidden;
    }
    
    .template-data-item {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .template-data-item:last-child {
      border-bottom: none;
    }
    
    .template-data-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }
    
    .template-data-value {
      font-size: 13px;
      color: var(--text-primary);
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    
    .template-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      background: rgba(0, 212, 255, 0.15);
      color: var(--accent-primary);
    }
    
    .template-badge.severity-critical,
    .template-badge.impact-critical {
      background: rgba(224, 17, 95, 0.15);
      color: #E0115F;
    }
    
    .template-badge.severity-high,
    .template-badge.impact-high {
      background: rgba(255, 107, 107, 0.15);
      color: #ff6b6b;
    }
    
    .template-badge.severity-medium,
    .template-badge.impact-medium {
      background: rgba(255, 146, 43, 0.15);
      color: #ff922b;
    }
    
    .template-badge.severity-low,
    .template-badge.impact-low {
      background: rgba(81, 207, 102, 0.15);
      color: #51cf66;
    }
    
    .moment-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }
    
    .moment-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      background: rgba(0, 212, 255, 0.1);
      border: 1px solid rgba(0, 212, 255, 0.3);
      border-radius: 12px;
      font-size: 11px;
      color: var(--accent-primary);
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .moment-tag:hover {
      background: rgba(0, 212, 255, 0.2);
      border-color: rgba(0, 212, 255, 0.5);
    }
    
    .moment-tag.auto-tag {
      background: rgba(255, 146, 43, 0.1);
      border-color: rgba(255, 146, 43, 0.3);
      color: #ff922b;
    }
    
    .moment-tag.auto-tag:hover {
      background: rgba(255, 146, 43, 0.2);
      border-color: rgba(255, 146, 43, 0.5);
    }
    
    .tag-remove {
      font-size: 12px;
      margin-left: 2px;
      opacity: 0.7;
    }
    
    .tag-remove:hover {
      opacity: 1;
    }
    
    .priority-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .priority-badge.critical {
      background: rgba(224, 17, 95, 0.2);
      color: #E0115F;
      border: 1px solid rgba(224, 17, 95, 0.5);
    }
    
    .priority-badge.follow-up {
      background: rgba(255, 146, 43, 0.2);
      color: #ff922b;
      border: 1px solid rgba(255, 146, 43, 0.5);
    }
    
    .priority-badge.pinned {
      background: rgba(255, 215, 0, 0.2);
      color: #ffd700;
      border: 1px solid rgba(255, 215, 0, 0.5);
    }
    
    .moment-priority {
      display: inline-block;
      margin-bottom: 8px;
    }
    
    .tags-input-container {
      position: relative;
      margin-top: 8px;
    }
    
    .tags-input {
      width: 100%;
      padding: 8px 12px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 13px;
    }
    
    .tags-input:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
    }
    
    .tags-display {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
      min-height: 30px;
    }
    
    .priority-selector {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    
    .priority-btn {
      flex: 1;
      padding: 8px 12px;
      background: var(--border-color);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-secondary);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    
    .priority-btn:hover {
      background: var(--border-color);
    }
    
    .priority-btn.active.critical {
      background: rgba(224, 17, 95, 0.2);
      border-color: rgba(224, 17, 95, 0.5);
      color: #E0115F;
    }
    
    .priority-btn.active.follow-up {
      background: rgba(255, 146, 43, 0.2);
      border-color: rgba(255, 146, 43, 0.5);
      color: #ff922b;
    }
    
    .priority-btn.active.pinned {
      background: rgba(255, 215, 0, 0.2);
      border-color: rgba(255, 215, 0, 0.5);
      color: #ffd700;
    }
    
    
    .chart-preview {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 12px;
    }
    
    .code-preview {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 12px;
    }
    
    .table-preview {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 12px;
    }
    
    /* Tables */
    .table-block-container {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      overflow: hidden;
      margin-top: 12px;
    }
    
    .table-block-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background: rgba(0, 0, 0, 0.3);
      border-bottom: 1px solid var(--border-color);
    }
    
    .table-block-title {
      font-size: 12px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .table-block-actions {
      display: flex;
      gap: 6px;
    }
    
    .table-wrapper {
      overflow-x: auto;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .trace-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    
    .trace-table thead {
      background: rgba(0, 212, 255, 0.1);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    
    .trace-table th {
      padding: 10px 12px;
      text-align: left;
      font-weight: 600;
      color: var(--accent-primary);
      border-bottom: 2px solid rgba(0, 212, 255, 0.3);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .trace-table td {
      padding: 10px 12px;
      color: #cbd5e1;
      border-bottom: 1px solid var(--border-color);
    }
    
    .trace-table tbody tr:hover {
      background: rgba(255, 255, 255, 0.03);
    }
    
    .trace-table tbody tr:last-child td {
      border-bottom: none;
    }
    
    .moment-tables {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 12px;
    }
    
    .form-actions {
      display: flex;
      gap: 10px;
      margin-top: 16px;
    }
    
    .btn-large {
      flex: 1;
      padding: 12px;
      font-size: 14px;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-capture {
      background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
      border: none;
      color: #0a0e1a;
      box-shadow: 0 4px 20px rgba(0, 212, 255, 0.3);
    }
    
    .btn-capture:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(0, 212, 255, 0.4);
    }
    
    .btn-cancel {
      background: var(--border-color);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
    }
    
    .btn-cancel:hover {
      background: var(--border-color);
    }
    
    /* Search View */
    .search-view {
      flex: 1;
      display: none;
      flex-direction: column;
      overflow: hidden;
    }
    
    .search-view.visible {
      display: flex;
    }
    
    .search-header {
      padding: 16px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .search-box {
      display: flex;
      gap: 10px;
      margin-bottom: 12px;
    }
    
    .search-input {
      flex: 1;
      padding: 12px 16px;
      background: rgba(0, 0, 0, 0.3);
      border: 2px solid var(--border-color);
      border-radius: 10px;
      color: var(--text-primary);
      font-size: 14px;
    }
    
    .search-input:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
    }
    
    .btn-search {
      padding: 12px 24px;
      background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
      border: none;
      border-radius: 10px;
      color: #0a0e1a;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .btn-search:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 20px rgba(0, 212, 255, 0.3);
    }
    
    .btn-search:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .search-hint {
      font-size: 12px;
      color: var(--text-muted);
      font-style: italic;
    }
    
    .search-results {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    
    .results-header {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 24px;
      color: var(--text-muted);
    }
    
    .empty-state-icon {
      margin-bottom: 12px;
      opacity: 0.3;
      font-size: 40px;
    }
    
    .empty-state h3 {
      font-size: 16px;
      margin-bottom: 6px;
      color: var(--text-secondary);
    }
    
    .empty-state p {
      font-size: 13px;
    }
    
    /* Graph View */
    .graph-view {
      flex: 1;
      display: none;
      overflow: hidden;
      position: relative;
    }
    
    .graph-view.visible {
      display: flex;
    }
    
    .graph-container-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .graph-header {
      padding: 16px;
      border-bottom: 1px solid var(--border-color);
      background: var(--bg-tertiary);
    }
    
    .graph-header h2 {
      font-size: 18px;
      margin-bottom: 4px;
      color: var(--text-primary);
    }
    
    .graph-subtitle {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }
    
    .graph-legend {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--text-secondary);
    }
    
    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }
    
    #graphContainer {
      flex: 1;
      position: relative;
      background: var(--bg-primary);
      overflow: hidden;
    }
    
    #graphContainer svg {
      width: 100%;
      height: 100%;
    }
    
    .graph-sidebar {
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 350px;
      background: var(--bg-tertiary);
      border-left: 1px solid var(--border-color);
      overflow-y: auto;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      z-index: 10;
    }
    
    .graph-sidebar.visible {
      transform: translateX(0);
    }
    
    .graph-sidebar-content {
      padding: 16px;
    }
    
    .graph-node-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }
    
    .graph-node-meta {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      font-size: 11px;
      color: var(--text-muted);
    }
    
    .graph-node-text {
      font-size: 13px;
      line-height: 1.5;
      color: var(--text-secondary);
      margin-bottom: 16px;
      padding: 12px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 6px;
    }
    
    .graph-links-section {
      margin-top: 16px;
    }
    
    .graph-links-section h4 {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .graph-link-item {
      padding: 8px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 4px;
      margin-bottom: 4px;
      cursor: pointer;
      font-size: 12px;
      color: var(--text-secondary);
      transition: all 0.2s;
    }
    
    .graph-link-item:hover {
      background: rgba(255, 255, 255, 0.06);
      color: var(--accent-primary);
    }
    
    .graph-node {
      cursor: pointer;
    }
    
    .graph-node circle {
      stroke: rgba(255, 255, 255, 0.3);
      stroke-width: 2px;
      transition: all 0.3s;
    }
    
    .graph-node:hover circle {
      stroke-width: 3px;
      stroke: var(--accent-primary);
    }
    
    .graph-node.selected circle {
      stroke: var(--accent-primary);
      stroke-width: 3px;
    }
    
    .graph-node text {
      fill: var(--text-primary);
      font-size: 11px;
      pointer-events: none;
      user-select: none;
    }
    
    .graph-link {
      stroke: rgba(255, 255, 255, 0.15);
      stroke-width: 1.5px;
    }
    
    .graph-link.highlighted {
      stroke: var(--ruby-accent);
      stroke-width: 2.5px;
    }
    
    /* Thread View */
    .thread-list {
      margin-top: 12px;
    }
    
    .thread-item {
      padding: 10px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 6px;
      margin-bottom: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .thread-item:hover {
      background: var(--border-color);
    }
    
    .thread-item.active {
      background: rgba(0, 212, 255, 0.1);
      border-left: 3px solid var(--accent-primary);
    }
    
    .thread-name {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 3px;
    }
    
    .thread-meta {
      font-size: 10px;
      color: var(--text-muted);
    }
    
    .hidden {
      display: none !important;
    }
    
    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .modal-overlay.visible {
      display: flex;
    }
    
    .modal {
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 24px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal-confirm {
      max-width: 400px;
      text-align: center;
    }
    
    .modal-wide {
      max-width: 700px;
    }
    
    .confirm-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
    
    .confirm-message {
      color: var(--text-secondary);
      font-size: 14px;
      line-height: 1.6;
      margin-top: 12px;
    }
    
    .modal h2 {
      font-size: 18px;
      margin-bottom: 16px;
      color: var(--text-primary);
    }
    
    .modal-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }
    
    .btn-delete {
      background: linear-gradient(135deg, #E0115F 0%, #72002c 100%);
      border: none;
      color: #fff;
      box-shadow: 0 4px 20px rgba(255, 107, 107, 0.3);
    }
    
    .btn-delete:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px #ff438b;
    }
    
    .btn-danger {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      background: rgba(255, 107, 107, 0.1);
      border: 1px solid rgba(255, 107, 107, 0.3);
      border-radius: 6px;
      color: #ff6b6b;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      width: 100%;
      justify-content: center;
    }
    
    .btn-danger:hover {
      background: rgba(255, 107, 107, 0.2);
      border-color: rgba(255, 107, 107, 0.5);
    }
    
    /* Thread Assignment */
    .thread-assignment {
      background: rgba(0, 212, 255, 0.05);
      border: 1px solid rgba(0, 212, 255, 0.2);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 16px;
    }
    
    .thread-assignment-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .thread-assignment-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--accent-primary);
      font-weight: 600;
    }
    
    .thread-remove-btn {
      background: rgba(255, 107, 107, 0.2);
      border: 1px solid rgba(255, 107, 107, 0.3);
      border-radius: 4px;
      color: #ff6b6b;
      padding: 2px 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .thread-remove-btn:hover {
      background: rgba(255, 107, 107, 0.3);
      border-color: rgba(255, 107, 107, 0.5);
    }
    
    .thread-select {
      width: 100%;
      padding: 8px 10px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(0, 212, 255, 0.3);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .thread-select:hover {
      border-color: rgba(0, 212, 255, 0.5);
    }
    
    .thread-select:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
    }
    
    .thread-select option {
      background: #1a1f2e;
      color: var(--text-primary);
    }
    
    /* Code Blocks */
    .code-textarea {
      font-family: 'Courier New', Monaco, monospace;
      font-size: 13px;
      line-height: 1.5;
      tab-size: 2;
    }
    
    .code-block-container {
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      overflow: hidden;
      margin-top: 12px;
    }
    
    .code-block-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background: rgba(0, 0, 0, 0.3);
      border-bottom: 1px solid var(--border-color);
    }
    
    .code-block-info {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .code-block-lang {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--accent-primary);
      font-weight: 600;
      padding: 2px 6px;
      background: rgba(0, 212, 255, 0.15);
      border-radius: 3px;
    }
    
    .code-block-title {
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    .code-block-actions {
      display: flex;
      gap: 6px;
    }
    
    .code-block-btn {
      padding: 4px 8px;
      font-size: 10px;
      background: var(--border-color);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .code-block-btn:hover {
      background: var(--border-color);
      color: var(--text-primary);
    }
    
    .code-block-content {
      padding: 12px;
      overflow-x: auto;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .code-block-pre {
      margin: 0;
      font-family: 'Courier New', Monaco, monospace;
      font-size: 13px;
      line-height: 1.5;
      color: var(--text-primary);
      white-space: pre;
    }
    
    /* Syntax Highlighting */
    .syntax-keyword { color: #E0115F; font-weight: 600; }
    .syntax-string { color: #51cf66; }
    .syntax-number { color: #ffd43b; }
    .syntax-comment { color: var(--text-muted); font-style: italic; }
    .syntax-function { color: var(--accent-primary); }
    .syntax-operator { color: #a78bfa; }
    .syntax-property { color: var(--text-secondary); }
    .syntax-tag { color: #E0115F; }
    .syntax-attr { color: var(--accent-primary); }
    
    .moment-code-blocks {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 12px;
    }
    
    /* Enhanced Chart */
    .chart-container {
      width: 100%;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 12px;
      position: relative;
      box-sizing: border-box;
    }
    
    .chart-controls {
      display: flex;
      gap: 6px;
      margin-top: 8px;
    }
    
    .chart-btn {
      padding: 4px 8px;
      font-size: 10px;
      background: var(--border-color);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .chart-btn:hover {
      background: var(--border-color);
      color: var(--text-primary);
    }
    
    .chart-value-display {
      position: absolute;
      background: rgba(0, 0, 0, 0.9);
      color: var(--accent-primary);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-family: 'Courier New', monospace;
      pointer-events: none;
      display: none;
      z-index: 10;
    }
    
    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.2);
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .logoModalBtn{
        background-color: transparent;
        all: unset;
        cursor: pointer;
        display: inline-block;
    }

    /* About Modal Specific Styles */
    .about-content {
      line-height: 1.7;
      color: #cbd5e1;
    }

    .about-content h3 {
      font-size: 16px;
      color: var(--accent-primary);
      margin-top: 20px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .about-content h3:first-child {
      margin-top: 0;
    }

    .about-content p {
      margin-bottom: 12px;
      font-size: 13px;
    }

    .about-content ul {
      margin-left: 20px;
      margin-bottom: 12px;
    }

    .about-content li {
      margin-bottom: 6px;
      font-size: 13px;
    }

    .about-content code {
      background: rgba(0, 0, 0, 0.3);
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: var(--accent-primary);
    }

    .feature-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin: 16px 0;
    }

    .feature-item {
      background: rgba(0, 0, 0, 0.2);
      padding: 12px;
      border-radius: 6px;
      border-left: 2px solid var(--accent-primary);
    }

    .feature-item-title {
      font-weight: 600;
      color: var(--accent-primary);
      font-size: 12px;
      margin-bottom: 4px;
    }

    .feature-item-desc {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .creator-section {
      margin-top: 24px;
      padding-top: 20px;
      border-top: 1px solid var(--border-color);
      text-align: center;
    }

    .creator-section p {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .creator-name {
      color: var(--accent-primary);
      font-weight: 600;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3@7.8.5/dist/d3.min.js"></script>
</head>
<body>
  <div class="trace-app">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-header">
        <div class="logo">
            <button class="logoModalBtn" onclick="showAboutModal()">
                <svg width="119" height="33" viewBox="0 0 119 33" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M14.4088 0L28.8087 8.03863V24.1159L14.4088 32.1545L0 24.1159V8.03863L14.4088 0Z" fill="#FC6188"/>
                <path d="M14.6623 16.0365L0.156921 24.0583L0.156922 8.01465L14.6623 16.0365Z" fill="#E0115F"/>
                <path d="M28.8087 8.03863L14.4089 15.9957L14.4089 0L28.8087 8.03863Z" fill="#E0115F"/>
                <path d="M28.8087 24.1159L14.2226 16.0346L28.8087 8.03864L28.8087 24.1159Z" fill="#A00942"/>
                <path d="M14.4088 32.1545L14.329 15.914L28.8086 24.1159L14.4088 32.1545Z" fill="#E0115F"/>
                <path d="M14.4089 7.18172L22.6007 11.7519V20.8923L14.4089 25.4625L6.21705 20.8923V11.7519L14.4089 7.18172Z" fill="#A00942"/>
                <path d="M14.4088 25.4625V7.18172L22.6011 11.3847V20.8923L14.4088 25.4625Z" fill="#FC6188"/>
                <path d="M42.6893 14.2641H48.9421C50.1946 14.2641 51.1817 13.9184 51.9031 13.227C52.6246 12.5356 52.9853 11.7239 52.9853 10.792C52.9853 9.77995 52.6046 8.90817 51.843 8.17668C51.0915 7.43516 50.0243 7.06441 48.6415 7.06441H42.6893V14.2641ZM37.3835 4.34386C38.7062 4.47412 40.55 4.53926 42.9148 4.53926C43.7665 4.53926 44.8287 4.49918 46.1013 4.41901C47.3839 4.33885 48.2306 4.29877 48.6415 4.29877C49.9041 4.29877 51.0414 4.48415 52.0534 4.8549C53.0755 5.21564 53.8972 5.70163 54.5185 6.31288C55.1498 6.9141 55.6307 7.59048 55.9614 8.34201C56.2921 9.09355 56.4574 9.87514 56.4574 10.6868C56.4574 11.1978 56.3773 11.7139 56.2169 12.235C56.0666 12.746 55.8261 13.242 55.4955 13.723C55.1648 14.194 54.769 14.6198 54.308 15.0006C53.8571 15.3714 53.301 15.682 52.6396 15.9325C51.9883 16.173 51.2869 16.3083 50.5353 16.3383C51.2969 16.5888 51.9482 17.0297 52.4893 17.661C53.0304 18.2823 53.4363 18.9487 53.7068 19.6601C53.9874 20.3615 54.2429 21.0529 54.4734 21.7343C54.7139 22.4057 54.9994 22.9668 55.3301 23.4178C55.6608 23.8587 56.0666 24.0791 56.5476 24.0791C57.9705 24.0791 58.682 24.2094 58.682 24.4699V25.026C58.682 25.3667 58.6569 25.6423 58.6068 25.8527C58.5567 26.0632 58.4415 26.2886 58.2611 26.5291C58.0807 26.7596 57.7851 26.9299 57.3743 27.0402C56.9635 27.1604 56.4324 27.2205 55.781 27.2205C55.1397 27.2205 54.5736 27.1153 54.0826 26.9049C53.6016 26.6844 53.2008 26.3938 52.8801 26.0331C52.5695 25.6623 52.2939 25.2365 52.0534 24.7555C51.8129 24.2745 51.5925 23.7635 51.3921 23.2224C51.2017 22.6813 51.0063 22.1352 50.8059 21.584C50.6155 21.0329 50.38 20.4968 50.0994 19.9757C49.8289 19.4447 49.5133 18.9687 49.1525 18.5478C48.8018 18.117 48.3459 17.7462 47.7847 17.4356C47.2336 17.1249 46.5973 16.9145 45.8758 16.8043H42.6893V22.9518C42.6893 23.1021 42.6943 23.2224 42.7044 23.3126C42.7244 23.3927 42.7595 23.4879 42.8096 23.5981C42.8697 23.7084 42.9699 23.7935 43.1102 23.8537C43.2505 23.9038 43.4308 23.9288 43.6513 23.9288C44.1122 23.9288 44.508 23.9889 44.8387 24.1092C45.1694 24.2294 45.3347 24.4098 45.3347 24.6503C45.3347 25.983 45.1694 26.7997 44.8387 27.1003C43.3357 26.9901 42.048 26.9349 40.9758 26.9349C40.054 26.9349 38.8565 26.9901 37.3835 27.1003C37.113 26.94 36.9125 26.6193 36.7823 26.1383C36.652 25.6573 36.5869 25.1613 36.5869 24.6503C36.5869 24.4098 36.7522 24.2294 37.0829 24.1092C37.4136 23.9889 37.8094 23.9288 38.2703 23.9288C38.6611 23.9288 38.9166 23.8486 39.0369 23.6883C39.1571 23.518 39.2172 23.2825 39.2172 22.9819V8.46226C39.2172 8.16165 39.1571 7.93118 39.0369 7.77085C38.9166 7.6005 38.6611 7.51533 38.2703 7.51533C37.148 7.51533 36.5869 7.2548 36.5869 6.73373C36.5869 6.24273 36.652 5.76175 36.7823 5.29079C36.9125 4.80981 37.113 4.49417 37.3835 4.34386Z" fill="white"/>
                <path d="M76.0875 11.8141V22.8316C76.0875 23.0921 76.0925 23.2775 76.1025 23.3877C76.1125 23.4979 76.1376 23.6232 76.1776 23.7635C76.2277 23.8937 76.3029 23.9839 76.4031 24.034C76.5133 24.0741 76.6586 24.1142 76.839 24.1543C77.0194 24.1843 77.2599 24.1994 77.5605 24.1994C78.0114 24.1994 78.297 24.2545 78.4172 24.3647C78.5475 24.4749 78.6126 24.7004 78.6126 25.0411C78.6126 25.5421 78.5525 25.988 78.4322 26.3788C78.322 26.7596 78.2168 26.985 78.1166 27.0552C77.3851 26.975 76.7087 26.9349 76.0875 26.9349C75.6766 26.9349 75.2457 26.955 74.7948 26.9951C74.3539 27.0351 74.0834 27.0552 73.9832 27.0552C73.5824 27.0552 73.3369 26.9349 73.2467 26.6945C73.1665 26.454 73.1264 25.8127 73.1264 24.7705C72.425 25.5822 71.5783 26.2135 70.5862 26.6644C69.6042 27.1153 68.6022 27.3408 67.5801 27.3408C66.8386 27.3408 66.1422 27.2155 65.4908 26.965C64.8495 26.7245 64.2684 26.3638 63.7473 25.8828C63.2262 25.4018 62.8154 24.7555 62.5148 23.9438C62.2142 23.1322 62.0639 22.2053 62.0639 21.1632V15.1359C62.0639 14.1839 61.8133 13.6879 61.3123 13.6478C61.2322 13.6378 61.1169 13.6278 60.9666 13.6178C60.8263 13.6078 60.7111 13.5977 60.6209 13.5877C60.5407 13.5777 60.4405 13.5677 60.3203 13.5577C60.2001 13.5376 60.1049 13.5226 60.0347 13.5126C59.9646 13.4925 59.8794 13.4725 59.7792 13.4524C59.689 13.4224 59.6189 13.3923 59.5688 13.3623C59.5187 13.3322 59.4686 13.2971 59.4185 13.257C59.3684 13.217 59.3333 13.1719 59.3132 13.1218C59.2932 13.0616 59.2832 12.9965 59.2832 12.9264C59.2832 11.764 59.4485 11.0325 59.7792 10.7319C60.7211 10.8421 61.5879 10.8972 62.3795 10.8972C62.9306 10.8972 63.4918 10.8722 64.0629 10.8221C64.6441 10.762 64.9447 10.7319 64.9648 10.7319C65.3055 10.7319 65.4758 11.0926 65.4758 11.8141V21.3435C65.4758 22.4458 65.7614 23.2725 66.3326 23.8236C66.9037 24.3747 67.6352 24.6503 68.527 24.6503C69.2886 24.6503 70.0451 24.4499 70.7967 24.0491C71.5582 23.6482 72.1845 23.1021 72.6755 22.4107V15.1359C72.6755 14.1839 72.425 13.6879 71.924 13.6478C71.8438 13.6378 71.7286 13.6278 71.5783 13.6178C71.438 13.6078 71.3227 13.5977 71.2326 13.5877C71.1524 13.5777 71.0522 13.5677 70.9319 13.5577C70.8117 13.5376 70.7165 13.5226 70.6464 13.5126C70.5762 13.4925 70.491 13.4725 70.3908 13.4524C70.3007 13.4224 70.2305 13.3923 70.1804 13.3623C70.1303 13.3322 70.0802 13.2971 70.0301 13.257C69.98 13.217 69.9449 13.1719 69.9249 13.1218C69.9049 13.0616 69.8948 12.9965 69.8948 12.9264C69.8948 11.754 70.0602 11.0225 70.3908 10.7319C71.3328 10.8421 72.1995 10.8972 72.9911 10.8972C73.6525 10.8972 74.3239 10.8722 75.0053 10.8221C75.6967 10.762 76.0524 10.7319 76.0724 10.7319C76.0825 10.7319 76.0875 11.0926 76.0875 11.8141Z" fill="white"/>
                <path d="M85.4516 17.8564V21.7794C85.7722 22.6211 86.3835 23.3326 87.2853 23.9138C88.1871 24.4849 89.2092 24.7705 90.3516 24.7705C91.564 24.7705 92.6112 24.2545 93.493 23.2224C94.3748 22.1802 94.8157 20.7373 94.8157 18.8935C94.8157 17.0498 94.3447 15.6118 93.4028 14.5797C92.4609 13.5476 91.3436 13.0316 90.0509 13.0316C89.4898 13.0316 88.9387 13.1368 88.3976 13.3472C87.8565 13.5476 87.3655 13.8432 86.9246 14.234C86.4837 14.6248 86.1279 15.1359 85.8574 15.7672C85.5868 16.3884 85.4516 17.0848 85.4516 17.8564ZM85.4516 6.67361V12.9865C85.9426 12.1849 86.644 11.5686 87.5559 11.1377C88.4777 10.6968 89.4147 10.4764 90.3666 10.4764C91.3787 10.4764 92.3557 10.6567 93.2976 11.0175C94.2395 11.3782 95.0862 11.8993 95.8378 12.5807C96.5993 13.252 97.2055 14.1338 97.6565 15.2261C98.1174 16.3183 98.3479 17.5408 98.3479 18.8935C98.3479 20.2463 98.1224 21.4738 97.6715 22.576C97.2206 23.6683 96.6143 24.5551 95.8528 25.2365C95.1013 25.9179 94.2595 26.4389 93.3276 26.7997C92.3957 27.1604 91.4238 27.3408 90.4117 27.3408C88.1571 27.3408 86.143 26.4991 84.3694 24.8156L82.8663 26.3187C82.3252 26.7997 81.8041 27.0402 81.3031 27.0402C80.9023 27.0402 80.5716 26.9099 80.3111 26.6494C80.0505 26.3888 79.9203 26.0632 79.9203 25.6724C79.9203 25.0711 80.2009 24.51 80.762 23.9889L82.0396 22.8165V8.76287C82.0396 8.23179 81.8843 7.85602 81.5737 7.63557C81.273 7.41512 80.6868 7.28486 79.8151 7.24478C79.6848 7.21472 79.5996 7.14958 79.5595 7.04938C79.5295 6.94917 79.5145 6.73373 79.5145 6.40306C79.5145 5.89202 79.5696 5.4411 79.6798 5.0503C79.79 4.6595 79.9002 4.43404 80.0105 4.37392C80.8422 4.48415 81.6388 4.53926 82.4003 4.53926C82.8513 4.53926 83.3272 4.51421 83.8283 4.4641C84.3293 4.40398 84.5948 4.37392 84.6249 4.37392C84.9756 4.37392 85.2011 4.4641 85.3013 4.64447C85.4115 4.81482 85.4666 5.21564 85.4666 5.84693C85.4666 5.91707 85.4616 6.04733 85.4516 6.23772C85.4516 6.41809 85.4516 6.56339 85.4516 6.67361Z" fill="white"/>
                <path d="M105.608 14.5346L109.471 23.1322L112.822 14.5346C112.873 14.3843 112.898 14.2491 112.898 14.1288C112.898 13.9384 112.817 13.7981 112.657 13.708C112.507 13.6178 112.336 13.5677 112.146 13.5577C111.966 13.5476 111.795 13.4975 111.635 13.4073C111.485 13.3071 111.41 13.1518 111.41 12.9414V12.8362C111.56 11.4934 111.73 10.7068 111.921 10.4764C112.903 10.7369 113.96 10.8672 115.092 10.8672C116.294 10.8672 117.402 10.7369 118.414 10.4764C118.805 10.6567 119 11.1327 119 11.9043C119 12.5155 118.88 12.9464 118.639 13.1969C118.399 13.4374 117.978 13.5577 117.377 13.5577C117.236 13.5577 117.111 13.5727 117.001 13.6027C116.891 13.6328 116.801 13.6629 116.73 13.6929C116.67 13.723 116.61 13.7781 116.55 13.8583C116.49 13.9384 116.45 14.0036 116.43 14.0537C116.41 14.0937 116.375 14.1689 116.325 14.2791C116.284 14.3894 116.254 14.4645 116.234 14.5046L110.222 28.3629C109.631 29.6755 108.924 30.6325 108.103 31.2337C107.291 31.845 106.294 32.1506 105.112 32.1506C104.17 32.1506 103.358 31.9652 102.677 31.5944C101.995 31.2337 101.655 30.8229 101.655 30.3619C101.655 29.7707 101.705 29.3699 101.805 29.1595C101.905 28.9591 102.085 28.8589 102.346 28.8589C102.446 28.8589 102.792 28.929 103.383 29.0693C103.984 29.2196 104.541 29.2948 105.052 29.2948C105.282 29.2948 105.462 29.2847 105.593 29.2647C105.723 29.2547 105.858 29.2046 105.998 29.1144C106.139 29.0242 106.244 28.939 106.314 28.8589C106.384 28.7787 106.494 28.6084 106.645 28.3478C106.795 28.0873 106.92 27.8418 107.021 27.6113C107.121 27.3909 107.291 27.0301 107.532 26.5291C107.782 26.0181 108.018 25.5371 108.238 25.0862C107.867 25.0862 107.592 25.0561 107.411 24.996C107.231 24.9258 107.096 24.7856 107.006 24.5751L102.196 14.5046C102.186 14.4745 102.156 14.3994 102.106 14.2791C102.055 14.1589 102.02 14.0837 102 14.0537C101.98 14.0136 101.935 13.9535 101.865 13.8733C101.805 13.7831 101.74 13.723 101.67 13.6929C101.61 13.6629 101.524 13.6328 101.414 13.6027C101.314 13.5727 101.194 13.5577 101.053 13.5577C100.452 13.5577 100.031 13.4374 99.7908 13.1969C99.5503 12.9464 99.4301 12.5155 99.4301 11.9043C99.4301 11.1327 99.6255 10.6567 100.016 10.4764C100.928 10.7369 102.035 10.8672 103.338 10.8672C104.661 10.8672 105.818 10.7369 106.81 10.4764C107.001 10.7068 107.171 11.4934 107.321 12.8362V12.9414C107.321 13.1518 107.226 13.3071 107.036 13.4073C106.845 13.5076 106.64 13.5627 106.419 13.5727C106.199 13.5827 105.993 13.6328 105.803 13.723C105.613 13.8032 105.518 13.9384 105.518 14.1288C105.518 14.2891 105.548 14.4244 105.608 14.5346Z" fill="white"/>
                </svg>
            </button>

        </div>
        
        <div class="theme-selector">
          <button class="theme-btn" id="themeToggle">
            <span><svg class="icon-action" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="13.5" cy="6.5" r=".5" fill="currentColor"/><circle cx="17.5" cy="10.5" r=".5" fill="currentColor"/><circle cx="8.5" cy="7.5" r=".5" fill="currentColor"/><circle cx="6.5" cy="12.5" r=".5" fill="currentColor"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"/></svg> Theme: <span id="currentThemeName">Ruby Classic</span></span>
            <span></span>
          </button>
          <div class="theme-dropdown" id="themeDropdown">
            <div class="theme-option active" data-theme="classic">
              <div class="theme-color-preview" style="background: #00d4ff;"></div>
              <span class="theme-name">Ruby Classic</span>
            </div>
            <div class="theme-option" data-theme="ruby-noir">
              <div class="theme-color-preview" style="background: #e0115f;"></div>
              <span class="theme-name">Ruby Noir</span>
            </div>
            <div class="theme-option" data-theme="ruby-twilight">
              <div class="theme-color-preview" style="background: #a78bfa;"></div>
              <span class="theme-name">Ruby Twilight</span>
            </div>
            <div class="theme-option" data-theme="ruby-forest">
              <div class="theme-color-preview" style="background: #34d399;"></div>
              <span class="theme-name">Ruby Forest</span>
            </div>
            <div class="theme-option" data-theme="ruby-ocean">
              <div class="theme-color-preview" style="background: #3b82f6;"></div>
              <span class="theme-name">Ruby Ocean</span>
            </div>
            <div class="theme-option" data-theme="ruby-ember">
              <div class="theme-color-preview" style="background: #f59e0b;"></div>
              <span class="theme-name">Ruby Ember</span>
            </div>
            <div class="theme-option" data-theme="ruby-slate">
              <div class="theme-color-preview" style="background: #58a6ff;"></div>
              <span class="theme-name">Ruby Slate</span>
            </div>
            <div class="theme-option" data-theme="ruby-midnight">
              <div class="theme-color-preview" style="background: #60a5fa;"></div>
              <span class="theme-name">Ruby Midnight</span>
            </div>
            <div class="theme-option" data-theme="ruby-crimson">
              <div class="theme-color-preview" style="background: #fb7185;"></div>
              <span class="theme-name">Ruby Crimson</span>
            </div>
            <div class="theme-option" data-theme="ruby-cosmic">
              <div class="theme-color-preview" style="background: #c084fc;"></div>
              <span class="theme-name">Ruby Cosmic</span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="nav-section">
        <h3>Views</h3>
        <div class="nav-item active" data-view="timeline">
          <svg class="icon-nav" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
          Timeline
        </div>
        <div class="nav-item" data-view="search">
          <svg class="icon-nav" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
          Search
        </div>
        <div class="nav-item" data-view="graph">
          <svg class="icon-nav" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/><path d="M3 12c0 1.66 4 3 9 3s9-1.34 9-3"/></svg>
          Graph
        </div>
        
        <h3>Filter by Type</h3>
        <div class="filter-item active" data-filter="all">
          <div class="filter-label">
            <svg class="icon-nav" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></svg>
            All Moments
          </div>
          <div class="filter-count" id="count-all">0</div>
        </div>
        <div class="filter-item" data-filter="incident">
          <div class="filter-label">
            <svg class="icon-nav" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 8v4"/><path d="M12 16h.01"/></svg>
            Incident
          </div>
          <div class="filter-count" id="count-incident">0</div>
        </div>
        <div class="filter-item" data-filter="deploy">
          <div class="filter-label">
            <svg class="icon-nav" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"/><path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/><path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0"/><path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5"/></svg>
            Deploy
          </div>
          <div class="filter-count" id="count-deploy">0</div>
        </div>
        <div class="filter-item" data-filter="idea">
          <div class="filter-label">
            <svg class="icon-nav" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>
            Idea
          </div>
          <div class="filter-count" id="count-idea">0</div>
        </div>
        <div class="filter-item" data-filter="observation">
          <div class="filter-label">
            <svg class="icon-nav" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="16"/></svg>
            Observation
          </div>
          <div class="filter-count" id="count-observation">0</div>
        </div>
        <div class="filter-item" data-filter="thought">
          <div class="filter-label">
            <svg class="icon-nav" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/></svg>
            Thought
          </div>
          <div class="filter-count" id="count-thought">0</div>
        </div>
        <div class="filter-item" data-filter="bug">
          <div class="filter-label">
            <svg class="icon-nav" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m8 2 1.88 1.88"/><path d="M14.12 3.88 16 2"/><path d="M9 7.13v-1a3.003 3.003 0 1 1 6 0v1"/><path d="M12 20c-3.3 0-6-2.7-6-6v-3a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v3c0 3.3-2.7 6-6 6"/><path d="M12 20v-9"/><path d="M6.53 9C4.6 8.8 3 7.1 3 5"/><path d="M6 13H2"/><path d="M3 21c0-2.1 1.7-3.9 3.8-4"/><path d="M20.97 5c0 2.1-1.6 3.8-3.5 4"/><path d="M22 13h-4"/><path d="M17.2 17c2.1.1 3.8 1.9 3.8 4"/></svg>
            Bug
          </div>
          <div class="filter-count" id="count-bug">0</div>
        </div>
        <div class="filter-item" data-filter="meeting">
          <div class="filter-label">
            <svg class="icon-nav" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
            Meeting
          </div>
          <div class="filter-count" id="count-meeting">0</div>
        </div>
        <div class="filter-item" data-filter="decision">
          <div class="filter-label">
            <svg class="icon-nav" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" x2="20" y1="9" y2="9"/><line x1="4" x2="20" y1="15" y2="15"/><line x1="10" x2="8" y1="3" y2="21"/><line x1="16" x2="14" y1="3" y2="21"/></svg>
            Decision
          </div>
          <div class="filter-count" id="count-decision">0</div>
        </div>
        <div class="filter-item" data-filter="review">
          <div class="filter-label">
            <svg class="icon-nav" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
            Review
          </div>
          <div class="filter-count" id="count-review">0</div>
        </div>
        <div class="filter-item" data-filter="question">
          <div class="filter-label">
            <svg class="icon-nav" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>
            Question
          </div>
          <div class="filter-count" id="count-question">0</div>
        </div>
        
        <h3>Threads</h3>
        <div class="thread-list" id="threadList"></div>
        <button class="btn-secondary" id="newThreadBtn" style="margin-top: 12px; width: 100%;">
          <svg class="icon-action" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg> New Thread
        </button>
        
        <div id="unthreadedFilter" class="filter-item hidden" style="margin-top: 12px;">
          <div class="filter-label">
            <svg class="icon-context" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" x2="12" y1="17" y2="22"/><path d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V6h1a2 2 0 0 0 0-4H8a2 2 0 0 0 0 4h1v4.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24Z"/></svg> Unthreaded
          </div>
          <div class="filter-count" id="count-unthreaded">0</div>
        </div>
      </div>
      
      <button class="btn-primary" id="captureMomentBtn">
        <svg class="icon-action" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg> Capture Moment
      </button>
    </div>
    
    <!-- Timeline View -->
    <div class="timeline-view" id="timelineView">
      <div class="timeline-list">
        <div class="timeline-header">
          <div class="timeline-title" id="timelineTitle">All Moments</div>
        </div>
        <div id="threadBanner" class="thread-banner hidden">
          <div class="thread-banner-content">
            <span class="thread-banner-icon"><svg class="icon-context" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 17h.01"/><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/></svg></span>
            <span class="thread-banner-text" id="threadBannerText"></span>
          </div>
          <div class="thread-banner-actions">
            <button class="thread-banner-btn" id="threadBannerDeleteBtn" onclick="confirmDeleteThread()" title="Delete Thread"><svg class="icon-action" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg></button>
            <button class="thread-banner-close" onclick="clearThreadFilter()"></button>
          </div>
        </div>
        <div id="momentsList"></div>
      </div>
      
      <div class="detail-panel" id="detailPanel"></div>
    </div>
    
    <!-- Capture View -->
    <div class="capture-view" id="captureView">
      <div class="capture-header">
        <h1 id="captureTitle">Capture a Moment</h1>
        <div class="capture-subtitle" id="captureSubtitle">What are you thinking right now?</div>
        <div id="captureThreadIndicator" class="capture-thread-indicator hidden"></div>
      </div>
      
      <div class="type-selector" id="typeSelector">
        <div class="type-btn active" data-type="thought" style="color: #a78bfa;">
          <div class="type-btn-icon"><svg class="icon-moment" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/></svg></div>
          <div class="type-btn-label">Thought</div>
        </div>
        <div class="type-btn" data-type="incident" style="color: #E0115F;">
          <div class="type-btn-icon"><svg class="icon-moment" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 8v4"/><path d="M12 16h.01"/></svg></div>
          <div class="type-btn-label">Incident</div>
        </div>
        <div class="type-btn" data-type="deploy" style="color: #51cf66;">
          <div class="type-btn-icon"><svg class="icon-moment" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"/><path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/><path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0"/><path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5"/></svg></div>
          <div class="type-btn-label">Deploy</div>
        </div>
        <div class="type-btn" data-type="idea" style="color: #ffd43b;">
          <div class="type-btn-icon"><svg class="icon-moment" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg></div>
          <div class="type-btn-label">Idea</div>
        </div>
        <div class="type-btn" data-type="observation" style="color: var(--accent-primary);">
          <div class="type-btn-icon"><svg class="icon-moment" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="16"/></svg></div>
          <div class="type-btn-label">Observation</div>
        </div>
        <div class="type-btn" data-type="bug" style="color: #9b003c;">
          <div class="type-btn-icon"><svg class="icon-moment" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m8 2 1.88 1.88"/><path d="M14.12 3.88 16 2"/><path d="M9 7.13v-1a3.003 3.003 0 1 1 6 0v1"/><path d="M12 20c-3.3 0-6-2.7-6-6v-3a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v3c0 3.3-2.7 6-6 6"/><path d="M12 20v-9"/><path d="M6.53 9C4.6 8.8 3 7.1 3 5"/><path d="M6 13H2"/><path d="M3 21c0-2.1 1.7-3.9 3.8-4"/><path d="M20.97 5c0 2.1-1.6 3.8-3.5 4"/><path d="M22 13h-4"/><path d="M17.2 17c2.1.1 3.8 1.9 3.8 4"/></svg></div>
          <div class="type-btn-label">Bug</div>
        </div>
        <div class="type-btn" data-type="meeting" style="color: #339af0;">
          <div class="type-btn-icon"><svg class="icon-moment" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></div>
          <div class="type-btn-label">Meeting</div>
        </div>
        <div class="type-btn" data-type="decision" style="color: #be4bdb;">
          <div class="type-btn-icon"><svg class="icon-moment" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" x2="20" y1="9" y2="9"/><line x1="4" x2="20" y1="15" y2="15"/><line x1="10" x2="8" y1="3" y2="21"/><line x1="16" x2="14" y1="3" y2="21"/></svg></div>
          <div class="type-btn-label">Decision</div>
        </div>
        <div class="type-btn" data-type="review" style="color: #20c997;">
          <div class="type-btn-icon"><svg class="icon-moment" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg></div>
          <div class="type-btn-label">Review</div>
        </div>
        <div class="type-btn" data-type="question" style="color: #ff922b;">
          <div class="type-btn-icon"><svg class="icon-moment" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg></div>
          <div class="type-btn-label">Question</div>
        </div>
      </div>
      
      <div class="form-group">
        <label class="form-label">Thread (Optional)</label>
        <div style="display: flex; gap: 12px; align-items: center;">
          <select id="captureThreadSelect" class="form-input" style="flex: 1; margin: 0;">
            <option value="">No thread</option>
          </select>
          <button class="btn-secondary" id="createThreadFromCaptureBtn" style="margin: 0; white-space: nowrap;">
            <svg class="icon-action" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg> New Thread
          </button>
        </div>
      </div>
      
      <div class="form-group">
        <label class="form-label">Your Thought</label>
        <textarea id="captureText" class="form-textarea" placeholder="What's on your mind? (Markdown + [[wikilinks]] supported)"></textarea>
      </div>
      
      <div id="templateFields" class="form-group" style="display: none;">
        <label class="form-label">Additional Details</label>
        <div id="templateFieldsContainer"></div>
      </div>
      
      <div class="form-grid">
        <div class="form-group" style="margin-bottom: 0;">
          <label class="form-label">Context (Optional)</label>
          <div class="context-fields">
            <input id="contextService" class="form-input" placeholder="Service name">
            <input id="contextEnvironment" class="form-input" placeholder="Environment" value="production">
            <input id="contextVersion" class="form-input" placeholder="Version/commit">
          </div>
        </div>
        
        <div class="form-group" style="margin-bottom: 0;">
          <label class="form-label">Priority / Pin</label>
          <div class="priority-selector">
            <button class="priority-btn" data-priority="critical">
               Critical
            </button>
            <button class="priority-btn" data-priority="follow-up">
               Follow-up
            </button>
            <button class="priority-btn" data-priority="pinned">
               Pinned
            </button>
            <button class="priority-btn" data-priority="none">
               None
            </button>
          </div>
        </div>
      </div>
      
      <div class="form-group">
        <label class="form-label">Tags</label>
        <div class="tags-input-container">
          <input id="tagsInput" class="tags-input" placeholder="Add tags (e.g., #latency, #ui, #customer-impact) - press Enter to add">
        </div>
        <div class="tags-display" id="tagsDisplay"></div>
      </div>
      
      <div class="form-group">
        <label class="form-label">Attachments</label>
        <div style="display: flex; gap: 12px; margin-bottom: 12px;">
          <button class="btn-secondary" id="addChartBtn" style="flex: 1; margin: 0;">
            <svg class="icon-content" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
            Chart
          </button>
          <button class="btn-secondary" id="addCodeBtn" style="flex: 1; margin: 0;">
            <svg class="icon-content" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
            Code
          </button>
          <button class="btn-secondary" id="addTableBtn" style="flex: 1; margin: 0;">
            <svg class="icon-content" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 9h18"/><path d="M3 15h18"/><path d="M9 3v18"/><path d="M15 3v18"/></svg>
            Table
          </button>
          <button class="btn-secondary" id="addFileBtn" style="flex: 1; margin: 0;">
            <svg class="icon-content" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.57a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>
            Files
          </button>
        </div>
        <input type="file" id="fileInput" multiple accept="image/*,application/pdf,.doc,.docx,.txt" style="display: none;">
        <div class="chart-preview" id="chartPreview"></div>
        <div class="code-preview" id="codePreview"></div>
        <div class="table-preview" id="tablePreview"></div>
        <div class="attachments-container" id="attachmentsPreview"></div>
      </div>
      
      <div class="form-actions">
        <button class="btn-large btn-cancel" id="cancelCaptureBtn">Cancel</button>
        <button class="btn-large btn-capture" id="submitCaptureBtn"><svg class="icon-action" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg> Capture Moment</button>
      </div>
    </div>
    
    <!-- Search View -->
    <div class="search-view" id="searchView">
      <div class="search-header">
        <div class="search-box">
          <input id="searchInput" class="search-input" placeholder="Search moments, tags (#latency), or priority (critical, pinned)...">
          <button class="btn-search" id="searchBtn">
             Search
          </button>
        </div>
        <div class="search-hint">
          Try: "times deploys increased errors", "ideas during outages", "thoughts about scaling"
        </div>
      </div>
      
      <div class="search-results" id="searchResults">
        <div class="empty-state">
          <div class="empty-state-icon"></div>
          <h3>Semantic Search</h3>
          <p>Search your moments by meaning, not just keywords</p>
        </div>
      </div>
    </div>
    
    <!-- Graph View -->
    <div class="graph-view" id="graphView">
      <div class="graph-container-wrapper">
        <div class="graph-header">
          <h2>Knowledge Graph</h2>
          <p class="graph-subtitle">Visualize connections between moments using [[wikilinks]]</p>
          <div class="graph-legend">
            <div class="legend-item">
              <div class="legend-dot" style="background: var(--accent-primary);"></div>
              <span>Selected</span>
            </div>
            <div class="legend-item">
              <div class="legend-dot" style="background: var(--ruby-accent);"></div>
              <span>Linked</span>
            </div>
            <div class="legend-item">
              <div class="legend-dot" style="background: var(--text-muted);"></div>
              <span>Unlinked</span>
            </div>
          </div>
        </div>
        <div id="graphContainer"></div>
      </div>
      
      <div class="detail-panel" id="graphDetailPanel"></div>
    </div>
  </div>

  <!-- About Modal -->
  <div class="modal-overlay" id="aboutModal">
    <div class="modal modal-wide">
      <h2> About RUBY</h2>
      
      <div class="about-content">
        <p><strong>RUBY</strong> (Requests-Utilities-Builds-Yields) is a developer-focused note-taking tool designed specifically for SREs, DevOps engineers, and developers who need to capture contextual information during critical moments.</p>
        
        <h3> The Concept</h3>
        <p>In fast-paced development and operations environments, context is everything. RUBY helps you capture thoughts, observations, and data exactly when they matter mostduring incidents, deployments, debugging sessions, and decision-making moments.</p>
        
        <p>Unlike traditional note-taking apps, RUBY is built around the concept of "moments"timestamped snapshots that include not just text, but also charts, code snippets, tables, and contextual metadata like service names, environments, and versions.</p>
        
        <h3> Key Features</h3>
        <div class="feature-grid">
          <div class="feature-item">
            <div class="feature-item-title"> Multiple Moment Types</div>
            <div class="feature-item-desc">Incidents, Deploys, Ideas, Bugs, Meetings, Decisions, and more</div>
          </div>
          <div class="feature-item">
            <div class="feature-item-title"><svg class="icon-context" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 17h.01"/><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/></svg> Thread Organization</div>
            <div class="feature-item-desc">Group related moments into threads for complex investigations</div>
          </div>
          <div class="feature-item">
            <div class="feature-item-title"> Rich Attachments</div>
            <div class="feature-item-desc">Embed charts, code blocks, and tables directly in your moments</div>
          </div>
          <div class="feature-item">
            <div class="feature-item-title"> Semantic Search</div>
            <div class="feature-item-desc">AI-powered search to find moments by meaning, not just keywords</div>
          </div>
          <div class="feature-item">
            <div class="feature-item-title"><svg class="icon-action" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="13.5" cy="6.5" r=".5" fill="currentColor"/><circle cx="17.5" cy="10.5" r=".5" fill="currentColor"/><circle cx="8.5" cy="7.5" r=".5" fill="currentColor"/><circle cx="6.5" cy="12.5" r=".5" fill="currentColor"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"/></svg> Syntax Highlighting</div>
            <div class="feature-item-desc">Beautiful code rendering with support for multiple languages</div>
          </div>
          <div class="feature-item">
            <div class="feature-item-title"><svg class="icon-action" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg> Local Storage</div>
            <div class="feature-item-desc">All data stays in your browsercomplete privacy</div>
          </div>
        </div>
        
        <h3> Getting Started</h3>
        <ul>
          <li><strong>Capture a Moment:</strong> Click the "Capture Moment" button to create a new entry</li>
          <li><strong>Choose a Type:</strong> Select the type that best describes what you're capturing</li>
          <li><strong>Add Context:</strong> Include service name, environment, and version information</li>
          <li><strong>Attach Data:</strong> Add charts for metrics, code snippets, or tables as needed</li>
          <li><strong>Organize with Threads:</strong> Create threads to group related moments together</li>
          <li><strong>Search & Filter:</strong> Use the sidebar to filter by type or search semantically</li>
        </ul>
        
        <h3> Pro Tips</h3>
        <ul>
          <li>Create threads for long-running incidents or investigations</li>
          <li>Use observation moments to track gradual changes over time</li>
          <li>Attach charts during incidents to visualize what you're seeing</li>
          <li>Use the semantic search to find "moments when latency spiked"</li>
          <li>Edit moments to add more information as situations develop</li>
        </ul>
        
        <div class="creator-section">
          <p>Created with  by <span class="creator-name">Vincent Feliciano</span></p>
          <p> 2026</p>
        </div>
      </div>
      
      <div class="modal-actions">
        <button class="btn-large btn-capture" onclick="hideAboutModal()">Got it!</button>
      </div>
    </div>
  </div>

  <!-- Chart Data Modal -->
  <div class="modal-overlay" id="chartModal">
    <div class="modal">
      <h2>Add Chart Data</h2>
      
      <div class="form-group">
        <label class="form-label">Chart Type</label>
        <select id="modalChartType" class="form-input">
          <option value="line">Line Chart</option>
          <option value="area">Area Chart</option>
          <option value="bar">Bar Chart</option>
          <option value="horizontalBar">Horizontal Bar Chart</option>
          <option value="scatter">Scatter Plot</option>
          <option value="pie">Pie Chart</option>
          <option value="donut">Donut Chart</option>
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label">Chart Title</label>
        <input id="modalChartTitle" class="form-input" placeholder="e.g., Latency (p95), Error Rate">
      </div>
      
      <div class="form-group">
        <label class="form-label">Data Points (comma-separated)</label>
        <textarea id="modalChartData" class="form-textarea" rows="4" placeholder="Enter values separated by commas&#10;e.g., 45, 52, 48, 63, 71, 68, 55, 49, 52, 58, 61, 54"></textarea>
      </div>
      
      <div class="form-group">
        <label class="form-label">Labels (optional, comma-separated)</label>
        <input id="modalChartLabels" class="form-input" placeholder="e.g., 1am, 2am, 3am, 4am...">
      </div>
      
      <div class="modal-actions">
        <button class="btn-large btn-cancel" id="modalCancelBtn">Cancel</button>
        <button class="btn-large btn-capture" id="modalAddBtn">Add Chart</button>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div class="modal-overlay" id="confirmModal">
    <div class="modal modal-confirm">
      <div class="confirm-icon" id="confirmIcon"></div>
      <h2 id="confirmTitle">Are you sure?</h2>
      <p id="confirmMessage" class="confirm-message"></p>
      
      <div class="modal-actions">
        <button class="btn-large btn-cancel" id="confirmCancelBtn">Cancel</button>
        <button class="btn-large btn-delete" id="confirmDeleteBtn">Delete</button>
      </div>
    </div>
  </div>

  <!-- Code Block Modal -->
  <div class="modal-overlay" id="codeModal">
    <div class="modal modal-wide">
      <h2>Add Code Block</h2>
      
      <div class="form-group">
        <label class="form-label">Language</label>
        <select id="modalCodeLanguage" class="form-input">
          <option value="javascript">JavaScript</option>
          <option value="python">Python</option>
          <option value="java">Java</option>
          <option value="cpp">C++</option>
          <option value="csharp">C#</option>
          <option value="go">Go</option>
          <option value="rust">Rust</option>
          <option value="sql">SQL</option>
          <option value="bash">Bash</option>
          <option value="json">JSON</option>
          <option value="yaml">YAML</option>
          <option value="html">HTML</option>
          <option value="css">CSS</option>
          <option value="markdown">Markdown</option>
          <option value="plain">Plain Text</option>
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label">Title (optional)</label>
        <input id="modalCodeTitle" class="form-input" placeholder="e.g., Database migration script">
      </div>
      
      <div class="form-group">
        <label class="form-label">Code</label>
        <textarea id="modalCodeContent" class="form-textarea code-textarea" rows="12" placeholder="Paste your code here..."></textarea>
      </div>
      
      <div class="modal-actions">
        <button class="btn-large btn-cancel" id="codeModalCancelBtn">Cancel</button>
        <button class="btn-large btn-capture" id="codeModalAddBtn">Add Code</button>
      </div>
    </div>
  </div>

  <!-- Table Modal -->
  <div class="modal-overlay" id="tableModal">
    <div class="modal modal-wide">
      <h2>Create Table</h2>
      
      <div class="form-group">
        <label class="form-label">Title (optional)</label>
        <input id="modalTableTitle" class="form-input" placeholder="e.g., Performance Metrics">
      </div>
      
      <div class="form-group">
        <label class="form-label">Table Data (CSV format)</label>
        <textarea id="modalTableContent" class="form-textarea" rows="8" placeholder="Enter data in CSV format:&#10;&#10;Header 1, Header 2, Header 3&#10;Row 1 Col 1, Row 1 Col 2, Row 1 Col 3&#10;Row 2 Col 1, Row 2 Col 2, Row 2 Col 3"></textarea>
        <div style="font-size: 11px; color: var(--text-muted); margin-top: 6px;">
           Tip: First row will be treated as headers. Separate columns with commas.
        </div>
      </div>
      
      <div class="modal-actions">
        <button class="btn-large btn-cancel" id="tableModalCancelBtn">Cancel</button>
        <button class="btn-large btn-capture" id="tableModalAddBtn">Add Table</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
  <script>
    // Constants
    const MOMENT_TYPES = {
      incident: { 
        icon: `<svg class="icon-moment" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 8v4"/><path d="M12 16h.01"/></svg>`, 
        color: '#E0115F', 
        label: 'Incident', 
        prompts: ['What looks wrong?', 'What changed recently?', 'Initial hypothesis'],
        template: [
          { name: 'impact', label: 'Impact', type: 'select', options: ['Critical', 'High', 'Medium', 'Low'] },
          { name: 'rootCause', label: 'Root Cause', type: 'textarea', placeholder: 'What caused this incident?' },
          { name: 'mitigation', label: 'Mitigation', type: 'textarea', placeholder: 'What steps were taken to resolve?' }
        ]
      },
      deploy: { 
        icon: `<svg class="icon-moment" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"/><path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/><path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0"/><path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5"/></svg>`, 
        color: '#51cf66', 
        label: 'Deploy', 
        prompts: ['What are the expectations?', 'What are the risks?', 'Success criteria'],
        template: [
          { name: 'deployedBy', label: 'Deployed By', type: 'text', placeholder: 'Your name' },
          { name: 'changes', label: 'Changes', type: 'textarea', placeholder: 'What was deployed?' },
          { name: 'rollbackPlan', label: 'Rollback Plan', type: 'textarea', placeholder: 'How to rollback if needed' }
        ]
      },
      idea: { 
        icon: `<svg class="icon-moment" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>`, 
        color: '#ffd43b', 
        label: 'Idea', 
        prompts: ['What problem does this solve?', 'Why now?'] 
      },
      observation: { 
        icon: `<svg class="icon-moment" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="16"/></svg>`, 
        color: 'var(--accent-primary)', 
        label: 'Observation', 
        prompts: ['What did you notice?', 'Why does it matter?'] 
      },
      thought: { 
        icon: `<svg class="icon-moment" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/></svg>`, 
        color: '#a78bfa', 
        label: 'Thought', 
        prompts: [] 
      },
      bug: { 
        icon: `<svg class="icon-moment" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m8 2 1.88 1.88"/><path d="M14.12 3.88 16 2"/><path d="M9 7.13v-1a3.003 3.003 0 1 1 6 0v1"/><path d="M12 20c-3.3 0-6-2.7-6-6v-3a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v3c0 3.3-2.7 6-6 6"/><path d="M12 20v-9"/><path d="M6.53 9C4.6 8.8 3 7.1 3 5"/><path d="M6 13H2"/><path d="M3 21c0-2.1 1.7-3.9 3.8-4"/><path d="M20.97 5c0 2.1-1.6 3.8-3.5 4"/><path d="M22 13h-4"/><path d="M17.2 17c2.1.1 3.8 1.9 3.8 4"/></svg>`, 
        color: '#fa5252', 
        label: 'Bug', 
        prompts: ['What is the bug?', 'Steps to reproduce', 'Expected vs actual behavior'],
        template: [
          { name: 'severity', label: 'Severity', type: 'select', options: ['Critical', 'High', 'Medium', 'Low'] },
          { name: 'stepsToReproduce', label: 'Steps to Reproduce', type: 'textarea', placeholder: '1. Go to...\n2. Click on...\n3. See error' },
          { name: 'expectedBehavior', label: 'Expected Behavior', type: 'textarea', placeholder: 'What should happen' },
          { name: 'actualBehavior', label: 'Actual Behavior', type: 'textarea', placeholder: 'What actually happens' }
        ]
      },
      meeting: { 
        icon: `<svg class="icon-moment" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>`, 
        color: '#339af0', 
        label: 'Meeting', 
        prompts: ['Key discussion points', 'Action items', 'Decisions made'],
        template: [
          { name: 'attendees', label: 'Attendees', type: 'text', placeholder: 'Who attended' },
          { name: 'actionItems', label: 'Action Items', type: 'textarea', placeholder: 'List of action items' },
          { name: 'nextSteps', label: 'Next Steps', type: 'textarea', placeholder: 'What happens next' }
        ]
      },
      decision: { 
        icon: `<svg class="icon-moment" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" x2="20" y1="9" y2="9"/><line x1="4" x2="20" y1="15" y2="15"/><line x1="10" x2="8" y1="3" y2="21"/><line x1="16" x2="14" y1="3" y2="21"/></svg>`, 
        color: '#be4bdb', 
        label: 'Decision', 
        prompts: ['What was decided?', 'Why?', 'Alternatives considered'],
        template: [
          { name: 'options', label: 'Options Considered', type: 'textarea', placeholder: 'List the options that were evaluated' },
          { name: 'chosen', label: 'Chosen Option', type: 'text', placeholder: 'What was decided' },
          { name: 'reason', label: 'Reasoning', type: 'textarea', placeholder: 'Why this option was chosen' },
          { name: 'tradeoffs', label: 'Trade-offs', type: 'textarea', placeholder: 'What are we giving up?' }
        ]
      },
      review: { 
        icon: `<svg class="icon-moment" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>`, 
        color: '#20c997', 
        label: 'Review', 
        prompts: ['What did you review?', 'Feedback notes', 'Approval status'],
        template: [
          { name: 'reviewType', label: 'Review Type', type: 'select', options: ['Code Review', 'Design Review', 'Architecture Review', 'Other'] },
          { name: 'findings', label: 'Findings', type: 'textarea', placeholder: 'What was found during review' },
          { name: 'approved', label: 'Status', type: 'select', options: ['Approved', 'Needs Changes', 'Rejected'] }
        ]
      },
      question: { 
        icon: `<svg class="icon-moment" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>`, 
        color: '#ff922b', 
        label: 'Question', 
        prompts: ['What needs clarification?', 'Context for the question'] 
      }
    };
    
    // State
    let state = {
      moments: [],
      threads: [],
      selectedMoment: null,
      selectedThread: null,
      view: 'timeline',
      filterType: 'all',
      searchQuery: '',
      searchResults: [],
      captureType: 'thought',
      captureText: '',
      captureContext: { service: '', environment: 'production', version: '' },
      captureCharts: [],
      captureCodeBlocks: [],
      captureTables: [],
      captureAttachments: [],
      captureTags: [],
      capturePriority: null,
      editingMoment: null
    };
    
    // About Modal Functions
    window.showAboutModal = function() {
      document.getElementById('aboutModal').classList.add('visible');
    };
    
    window.hideAboutModal = function() {
      document.getElementById('aboutModal').classList.remove('visible');
    };
    
    // Close about modal on overlay click
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('aboutModal').addEventListener('click', (e) => {
        if (e.target.id === 'aboutModal') {
          hideAboutModal();
        }
      });
    });
    
    // Utility Functions
    function generateId() {
      return `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    }
    
    function formatTime(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diff = now - date;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      
      if (minutes < 1) return 'just now';
      if (minutes < 60) return `${minutes}m ago`;
      if (hours < 24) return `${hours}h ago`;
      if (days < 7) return `${days}d ago`;
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }
    
    // Markdown Parser
    function parseMarkdown(text, momentId = null) {
      if (!text) return '';
      
      // Parse wikilinks [[text]] before markdown
      let processedText = text.replace(/\[\[([^\]]+)\]\]/g, (match, linkText) => {
        // Find moment by title (first 50 chars of text) or ID
        const targetMoment = state.moments.find(m => 
          m.text.substring(0, 50).toLowerCase().includes(linkText.toLowerCase()) ||
          m.id === linkText
        );
        
        if (targetMoment) {
          return `<a href="#" class="wikilink" data-moment-id="${targetMoment.id}" onclick="navigateToMoment('${targetMoment.id}'); return false;">[[${linkText}]]</a>`;
        }
        
        // If no moment found, just return the text
        return `<span class="wikilink-missing">[[${linkText}]]</span>`;
      });
      
      // Configure marked to be safe
      marked.setOptions({
        breaks: true,
        gfm: true,
        headerIds: false,
        mangle: false
      });
      
      return marked.parse(processedText);
    }
    
    // Extract wikilinks from text
    function extractWikilinks(text) {
      if (!text) return [];
      const regex = /\[\[([^\]]+)\]\]/g;
      const links = [];
      let match;
      
      while ((match = regex.exec(text)) !== null) {
        links.push(match[1]);
      }
      
      return links;
    }
    
    // Get linked moments
    function getLinkedMoments(momentId) {
      const moment = state.moments.find(m => m.id === momentId);
      if (!moment) return { outgoing: [], incoming: [] };
      
      const wikilinks = extractWikilinks(moment.text);
      const outgoing = [];
      
      wikilinks.forEach(linkText => {
        const targetMoment = state.moments.find(m => 
          m.text.substring(0, 50).toLowerCase().includes(linkText.toLowerCase()) ||
          m.id === linkText
        );
        if (targetMoment) {
          outgoing.push(targetMoment);
        }
      });
      
      // Find moments that link to this one
      const incoming = state.moments.filter(m => {
        if (m.id === momentId) return false;
        const links = extractWikilinks(m.text);
        return links.some(linkText => 
          moment.text.substring(0, 50).toLowerCase().includes(linkText.toLowerCase()) ||
          moment.id === linkText
        );
      });
      
      return { outgoing, incoming };
    }
    
    // Navigate to moment from wikilink
    window.navigateToMoment = function(momentId) {
      const moment = state.moments.find(m => m.id === momentId);
      if (moment) {
        state.selectedMoment = moment;
        state.view = 'timeline';
        render();
      }
    };
    
    // Syntax Highlighting
    function highlightCode(code, language) {
      code = code
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
      
      switch(language) {
        case 'javascript':
        case 'java':
        case 'cpp':
        case 'csharp':
        case 'go':
        case 'rust':
          code = code.replace(/\b(const|let|var|function|return|if|else|for|while|class|import|export|from|async|await|new|this|super|extends|try|catch|throw|break|continue|switch|case|default|do|public|private|protected|static|void|int|string|bool|float|double)\b/g, '<span class="syntax-keyword">$1</span>');
          code = code.replace(/(".*?"|'.*?'|`.*?`)/g, '<span class="syntax-string">$1</span>');
          code = code.replace(/\b(\d+\.?\d*)\b/g, '<span class="syntax-number">$1</span>');
          code = code.replace(/(\/\/.*$)/gm, '<span class="syntax-comment">$1</span>');
          code = code.replace(/(\/\*[\s\S]*?\*\/)/g, '<span class="syntax-comment">$1</span>');
          code = code.replace(/\b([a-zA-Z_]\w*)\s*\(/g, '<span class="syntax-function">$1</span>(');
          break;
          
        case 'python':
          code = code.replace(/\b(def|class|return|if|elif|else|for|while|import|from|as|with|try|except|finally|raise|break|continue|pass|lambda|yield|async|await|None|True|False)\b/g, '<span class="syntax-keyword">$1</span>');
          code = code.replace(/(".*?"|'.*?'|"""[\s\S]*?"""|'''[\s\S]*?''')/g, '<span class="syntax-string">$1</span>');
          code = code.replace(/\b(\d+\.?\d*)\b/g, '<span class="syntax-number">$1</span>');
          code = code.replace(/(#.*$)/gm, '<span class="syntax-comment">$1</span>');
          code = code.replace(/\b([a-zA-Z_]\w*)\s*\(/g, '<span class="syntax-function">$1</span>(');
          break;
          
        case 'sql':
          code = code.replace(/\b(SELECT|FROM|WHERE|JOIN|LEFT|RIGHT|INNER|OUTER|ON|AND|OR|NOT|IN|LIKE|ORDER BY|GROUP BY|HAVING|INSERT|UPDATE|DELETE|CREATE|DROP|TABLE|DATABASE|INDEX|VIEW|AS|DISTINCT|COUNT|SUM|AVG|MAX|MIN)\b/gi, '<span class="syntax-keyword">$1</span>');
          code = code.replace(/('.*?')/g, '<span class="syntax-string">$1</span>');
          code = code.replace(/\b(\d+\.?\d*)\b/g, '<span class="syntax-number">$1</span>');
          code = code.replace(/(--.*$)/gm, '<span class="syntax-comment">$1</span>');
          break;
          
        case 'bash':
          code = code.replace(/\b(if|then|else|elif|fi|for|while|do|done|case|esac|function|return|exit|echo|cd|ls|grep|awk|sed)\b/g, '<span class="syntax-keyword">$1</span>');
          code = code.replace(/(".*?"|'.*?')/g, '<span class="syntax-string">$1</span>');
          code = code.replace(/(#.*$)/gm, '<span class="syntax-comment">$1</span>');
          break;
          
        case 'html':
          code = code.replace(/(&lt;\/?[a-zA-Z][a-zA-Z0-9]*)/g, '<span class="syntax-tag">$1</span>');
          code = code.replace(/(&gt;)/g, '<span class="syntax-tag">$1</span>');
          code = code.replace(/\s([a-zA-Z-]+)=/g, ' <span class="syntax-attr">$1</span>=');
          code = code.replace(/(".*?"|'.*?')/g, '<span class="syntax-string">$1</span>');
          break;
          
        case 'css':
          code = code.replace(/([a-zA-Z-]+):/g, '<span class="syntax-property">$1</span>:');
          code = code.replace(/(".*?"|'.*?')/g, '<span class="syntax-string">$1</span>');
          code = code.replace(/\b(\d+\.?\d*(px|em|rem|%|vh|vw)?)\b/g, '<span class="syntax-number">$1</span>');
          code = code.replace(/(\/\*[\s\S]*?\*\/)/g, '<span class="syntax-comment">$1</span>');
          break;
          
        case 'json':
        case 'yaml':
          code = code.replace(/(".*?")/g, '<span class="syntax-string">$1</span>');
          code = code.replace(/\b(\d+\.?\d*)\b/g, '<span class="syntax-number">$1</span>');
          code = code.replace(/\b(true|false|null)\b/g, '<span class="syntax-keyword">$1</span>');
          code = code.replace(/(".*?"):/g, '<span class="syntax-property">$1</span>:');
          break;
      }
      
      return code;
    }
    
    // Code Block Component
    function createCodeBlock(language, code, title = '', codeId = null) {
      const id = codeId || `code-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
      const container = document.createElement('div');
      container.className = 'code-block-container';
      container.dataset.codeId = id;
      container.dataset.codeData = JSON.stringify({ language, code, title });
      
      const highlightedCode = highlightCode(code, language);
      
      let actionsHtml = '';
      if (codeId) {
        actionsHtml = `
          <div class="code-block-actions">
            <button class="code-block-btn" onclick="editCodeBlock('${id}')"><svg class="icon-action" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.12 2.12 0 0 1 3 3L12 15l-4 1 1-4Z"/></svg> Edit</button>
            <button class="code-block-btn" onclick="removeCodeBlock('${id}')"><svg class="icon-action" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg> Remove</button>
          </div>
        `;
      }
      
      container.innerHTML = `
        <div class="code-block-header">
          <div class="code-block-info">
            <span class="code-block-lang">${language}</span>
            ${title ? `<span class="code-block-title">${title}</span>` : ''}
          </div>
          ${actionsHtml}
        </div>
        <div class="code-block-content">
          <pre class="code-block-pre">${highlightedCode}</pre>
        </div>
      `;
      
      return container;
    }
    
    // Table Component
    function createTable(title, data, tableId = null) {
      const id = tableId || `table-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
      const container = document.createElement('div');
      container.className = 'table-block-container';
      container.dataset.tableId = id;
      container.dataset.tableData = JSON.stringify({ title, data });
      
      let actionsHtml = '';
      if (tableId) {
        actionsHtml = `
          <div class="table-block-actions">
            <button class="code-block-btn" onclick="editTable('${id}')"><svg class="icon-action" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.12 2.12 0 0 1 3 3L12 15l-4 1 1-4Z"/></svg> Edit</button>
            <button class="code-block-btn" onclick="removeTable('${id}')"><svg class="icon-action" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg> Remove</button>
          </div>
        `;
      }
      
      const rows = data.trim().split('\n').map(row => 
        row.split(',').map(cell => cell.trim())
      );
      
      const headers = rows[0] || [];
      const bodyRows = rows.slice(1);
      
      let tableHtml = '<table class="trace-table"><thead><tr>';
      headers.forEach(header => {
        tableHtml += `<th>${header}</th>`;
      });
      tableHtml += '</tr></thead><tbody>';
      
      bodyRows.forEach(row => {
        tableHtml += '<tr>';
        row.forEach(cell => {
          tableHtml += `<td>${cell}</td>`;
        });
        tableHtml += '</tr>';
      });
      
      tableHtml += '</tbody></table>';
      
      container.innerHTML = `
        <div class="table-block-header">
          <div class="table-block-title">
             ${title || 'Table'}
          </div>
          ${actionsHtml}
        </div>
        <div class="table-wrapper">
          ${tableHtml}
        </div>
      `;
      
      return container;
    }
    
    // Storage Functions
    async function loadData() {
      const moments = localStorage.getItem('trace-moments');
      const threads = localStorage.getItem('trace-threads');
      
      if (moments) state.moments = JSON.parse(moments);
      if (threads) state.threads = JSON.parse(threads);
      
      render();
    }
    
    function saveData() {
      localStorage.setItem('trace-moments', JSON.stringify(state.moments));
      localStorage.setItem('trace-threads', JSON.stringify(state.threads));
    }
    
    // Chart Generation
    function createChart(title, data, color, labels = null, chartId = null, chartType = 'line') {
      const id = chartId || `chart-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
      
      const container = document.createElement('div');
      container.className = 'chart-container';
      container.style.position = 'relative';
      container.dataset.chartId = id;
      container.dataset.chartData = JSON.stringify({ title, data, labels, chartType });
      
      const header = document.createElement('div');
      header.className = 'chart-header';
      header.textContent = ` ${title}`;
      container.appendChild(header);
      
      const valueDisplay = document.createElement('div');
      valueDisplay.className = 'chart-value-display';
      container.appendChild(valueDisplay);
      
      const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      svg.style.width = '100%';
      svg.style.height = '140px';
      svg.style.display = 'block';
      svg.setAttribute('data-chart-id', id);
      
      container.appendChild(svg);
      
      setTimeout(() => {
       const containerWidth = Math.max(container.offsetWidth - 24, 200);
        const width = containerWidth;
        const height = 140;
        const padding = 20;
        const chartHeight = height - padding * 2;
        const chartWidth = width - padding * 2;
        
        svg.setAttribute('width', width);
        svg.setAttribute('height', height);
        
        const max = Math.max(...data);
        const min = Math.min(...data);
        const range = max - min || 1;
        
        svg.innerHTML = '';
        
        for (let i = 0; i <= 4; i++) {
          const y = padding + (chartHeight / 4) * i;
          const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
          line.setAttribute('x1', padding);
          line.setAttribute('y1', y);
          line.setAttribute('x2', width - padding);
          line.setAttribute('y2', y);
          line.setAttribute('stroke', 'var(--border-color)');
          line.setAttribute('stroke-width', '1');
          svg.appendChild(line);
          
          const value = max - (range / 4) * i;
          const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
          text.setAttribute('x', '5');
          text.setAttribute('y', y + 3);
          text.setAttribute('fill', 'var(--text-muted)');
          text.setAttribute('font-size', '10');
          text.textContent = value.toFixed(0);
          svg.appendChild(text);
        }
        
        if (chartType === 'bar') {
          const barWidth = (chartWidth / data.length) * 0.7;
          const barGap = (chartWidth / data.length) * 0.3;
          
          data.forEach((value, i) => {
            const x = padding + (i / data.length) * chartWidth + barGap / 2;
            const barHeight = ((value - min) / range) * chartHeight;
            const y = padding + chartHeight - barHeight;
            
            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rect.setAttribute('x', x);
            rect.setAttribute('y', y);
            rect.setAttribute('width', barWidth);
            rect.setAttribute('height', barHeight);
            rect.setAttribute('fill', color);
            rect.setAttribute('opacity', '0.7');
            rect.setAttribute('data-value', value);
            rect.setAttribute('data-label', labels && labels[i] ? labels[i] : `Bar ${i + 1}`);
            rect.style.cursor = 'pointer';
            rect.setAttribute('class', 'chart-bar');
            
            svg.appendChild(rect);
          });
        } else if (chartType === 'horizontalBar') {
          const barHeight = (chartHeight / data.length) * 0.7;
          const barGap = (chartHeight / data.length) * 0.3;
          
          data.forEach((value, i) => {
            const barWidth = ((value - min) / range) * chartWidth;
            const x = padding;
            const y = padding + (i / data.length) * chartHeight + barGap / 2;
            
            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rect.setAttribute('x', x);
            rect.setAttribute('y', y);
            rect.setAttribute('width', barWidth);
            rect.setAttribute('height', barHeight);
            rect.setAttribute('fill', color);
            rect.setAttribute('opacity', '0.7');
            rect.setAttribute('data-value', value);
            rect.setAttribute('data-label', labels && labels[i] ? labels[i] : `Bar ${i + 1}`);
            rect.style.cursor = 'pointer';
            rect.setAttribute('class', 'chart-bar');
            
            svg.appendChild(rect);
          });
        } else if (chartType === 'area') {
          const areaPoints = data.map((value, i) => {
            const x = padding + (i / (data.length - 1)) * chartWidth;
            const y = padding + chartHeight - ((value - min) / range) * chartHeight;
            return `${x},${y}`;
          }).join(' ');
          
          const area = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
          area.setAttribute('points', `${padding},${height - padding} ${areaPoints} ${width - padding},${height - padding}`);
          area.setAttribute('fill', color);
          area.setAttribute('opacity', '0.4');
          svg.appendChild(area);
          
          data.forEach((value, i) => {
            const x = padding + (i / (data.length - 1)) * chartWidth;
            const y = padding + chartHeight - ((value - min) / range) * chartHeight;
            
            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            circle.setAttribute('cx', x);
            circle.setAttribute('cy', y);
            circle.setAttribute('r', '4');
            circle.setAttribute('fill', color);
            circle.setAttribute('opacity', '0.8');
            circle.setAttribute('data-value', value);
            circle.setAttribute('data-label', labels && labels[i] ? labels[i] : `Point ${i + 1}`);
            circle.style.cursor = 'pointer';
            
            svg.appendChild(circle);
          });
        } else if (chartType === 'scatter') {
          data.forEach((value, i) => {
            const x = padding + (i / (data.length - 1)) * chartWidth;
            const y = padding + chartHeight - ((value - min) / range) * chartHeight;
            
            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            circle.setAttribute('cx', x);
            circle.setAttribute('cy', y);
            circle.setAttribute('r', '5');
            circle.setAttribute('fill', color);
            circle.setAttribute('opacity', '0.6');
            circle.setAttribute('data-value', value);
            circle.setAttribute('data-label', labels && labels[i] ? labels[i] : `Point ${i + 1}`);
            circle.style.cursor = 'pointer';
            
            svg.appendChild(circle);
          });
        } else if (chartType === 'pie' || chartType === 'donut') {
          const total = data.reduce((sum, val) => sum + val, 0);
          const centerX = width / 2;
          const centerY = height / 2;
          const radius = Math.min(chartWidth, chartHeight) / 2;
          const innerRadius = chartType === 'donut' ? radius * 0.5 : 0;
          
          let currentAngle = -Math.PI / 2;
          
          data.forEach((value, i) => {
            const sliceAngle = (value / total) * 2 * Math.PI;
            const endAngle = currentAngle + sliceAngle;
            
            const hue = (i / data.length) * 360;
            const sliceColor = `hsl(${hue}, 70%, 60%)`;
            
            if (chartType === 'donut') {
              const x1 = centerX + Math.cos(currentAngle) * radius;
              const y1 = centerY + Math.sin(currentAngle) * radius;
              const x2 = centerX + Math.cos(endAngle) * radius;
              const y2 = centerY + Math.sin(endAngle) * radius;
              const x3 = centerX + Math.cos(endAngle) * innerRadius;
              const y3 = centerY + Math.sin(endAngle) * innerRadius;
              const x4 = centerX + Math.cos(currentAngle) * innerRadius;
              const y4 = centerY + Math.sin(currentAngle) * innerRadius;
              
              const largeArc = sliceAngle > Math.PI ? 1 : 0;
              
              const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
              path.setAttribute('d', `
                M ${x1} ${y1}
                A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2}
                L ${x3} ${y3}
                A ${innerRadius} ${innerRadius} 0 ${largeArc} 0 ${x4} ${y4}
                Z
              `);
              path.setAttribute('fill', sliceColor);
              path.setAttribute('opacity', '0.8');
              path.setAttribute('data-value', value);
              path.setAttribute('data-label', labels && labels[i] ? labels[i] : `Slice ${i + 1}`);
              path.style.cursor = 'pointer';
              path.setAttribute('class', 'chart-slice');
              
              svg.appendChild(path);
            } else {
              const x1 = centerX + Math.cos(currentAngle) * radius;
              const y1 = centerY + Math.sin(currentAngle) * radius;
              const x2 = centerX + Math.cos(endAngle) * radius;
              const y2 = centerY + Math.sin(endAngle) * radius;
              
              const largeArc = sliceAngle > Math.PI ? 1 : 0;
              
              const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
              path.setAttribute('d', `
                M ${centerX} ${centerY}
                L ${x1} ${y1}
                A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2}
                Z
              `);
              path.setAttribute('fill', sliceColor);
              path.setAttribute('opacity', '0.8');
              path.setAttribute('data-value', value);
              path.setAttribute('data-label', labels && labels[i] ? labels[i] : `Slice ${i + 1}`);
              path.style.cursor = 'pointer';
              path.setAttribute('class', 'chart-slice');
              
              svg.appendChild(path);
            }
            
            currentAngle = endAngle;
          });
        } else {
          const areaPoints = data.map((value, i) => {
            const x = padding + (i / (data.length - 1)) * chartWidth;
            const y = padding + chartHeight - ((value - min) / range) * chartHeight;
            return `${x},${y}`;
          }).join(' ');
          
          const area = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
          area.setAttribute('points', `${padding},${height - padding} ${areaPoints} ${width - padding},${height - padding}`);
          area.setAttribute('fill', color);
          area.setAttribute('opacity', '0.2');
          svg.appendChild(area);
          
          const linePoints = data.map((value, i) => {
            const x = padding + (i / (data.length - 1)) * chartWidth;
            const y = padding + chartHeight - ((value - min) / range) * chartHeight;
            return `${x},${y}`;
          }).join(' ');
          
          const polyline = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
          polyline.setAttribute('points', linePoints);
          polyline.setAttribute('fill', 'none');
          polyline.setAttribute('stroke', color);
          polyline.setAttribute('stroke-width', '2');
          polyline.setAttribute('opacity', '0.8');
          svg.appendChild(polyline);
          
          data.forEach((value, i) => {
            const x = padding + (i / (data.length - 1)) * chartWidth;
            const y = padding + chartHeight - ((value - min) / range) * chartHeight;
            
            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            circle.setAttribute('cx', x);
            circle.setAttribute('cy', y);
            circle.setAttribute('r', '4');
            circle.setAttribute('fill', color);
            circle.setAttribute('opacity', '0.8');
            circle.setAttribute('data-value', value);
            circle.setAttribute('data-label', labels && labels[i] ? labels[i] : `Point ${i + 1}`);
            circle.style.cursor = 'pointer';
            
            svg.appendChild(circle);
          });
        }
        
        svg.addEventListener('mouseover', (e) => {
          if (e.target.tagName === 'circle' || e.target.classList.contains('chart-bar') || e.target.classList.contains('chart-slice')) {
            const value = e.target.getAttribute('data-value');
            const label = e.target.getAttribute('data-label');
            valueDisplay.textContent = `${label}: ${parseFloat(value).toFixed(2)}`;
            valueDisplay.style.display = 'block';
            valueDisplay.style.left = e.offsetX + 10 + 'px';
            valueDisplay.style.top = e.offsetY - 10 + 'px';
            if (e.target.tagName === 'circle') {
              e.target.setAttribute('r', '6');
            } else if (e.target.classList.contains('chart-bar')) {
              e.target.setAttribute('opacity', '1');
            } else if (e.target.classList.contains('chart-slice')) {
              e.target.setAttribute('opacity', '1');
            }
          }
        });
        
        svg.addEventListener('mouseout', (e) => {
          if (e.target.tagName === 'circle') {
            valueDisplay.style.display = 'none';
            e.target.setAttribute('r', '4');
          } else if (e.target.classList.contains('chart-bar')) {
            valueDisplay.style.display = 'none';
            e.target.setAttribute('opacity', '0.7');
          } else if (e.target.classList.contains('chart-slice')) {
            valueDisplay.style.display = 'none';
            e.target.setAttribute('opacity', '0.8');
          }
        });
        
        svg.addEventListener('mousemove', (e) => {
          if (e.target.tagName === 'circle' || e.target.classList.contains('chart-bar') || e.target.classList.contains('chart-slice')) {
            valueDisplay.style.left = e.offsetX + 10 + 'px';
            valueDisplay.style.top = e.offsetY - 10 + 'px';
          }
        });
      }, 10);
      
      if (chartId) {
        const controls = document.createElement('div');
        controls.className = 'chart-controls';
        controls.innerHTML = `
          <button class="chart-btn" onclick="editChart('${id}')"><svg class="icon-action" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.12 2.12 0 0 1 3 3L12 15l-4 1 1-4Z"/></svg> Edit</button>
          <button class="chart-btn" onclick="removeChart('${id}')"><svg class="icon-action" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg> Remove</button>
        `;
        container.appendChild(controls);
      }
      
      return container;
    }

    
    function createTemplateDisplay(templateData, templateConfig, compact = false) {
      if (!templateData || !templateConfig) return null;
      
      const container = document.createElement('div');
      container.className = 'template-data-display';
      
      templateConfig.forEach(field => {
        const value = templateData[field.name];
        if (!value) return;
        
        const item = document.createElement('div');
        item.className = 'template-data-item';
        
        const label = document.createElement('div');
        label.className = 'template-data-label';
        label.textContent = field.label;
        item.appendChild(label);
        
        const valueDiv = document.createElement('div');
        valueDiv.className = 'template-data-value';
        
        // Add badge styling for severity/impact/status fields
        if ((field.name === 'severity' || field.name === 'impact') && field.type === 'select') {
          const badge = document.createElement('span');
          badge.className = `template-badge ${field.name}-${value.toLowerCase()}`;
          badge.textContent = value;
          valueDiv.appendChild(badge);
        } else if (field.name === 'approved' && field.type === 'select') {
          const badge = document.createElement('span');
          badge.className = 'template-badge';
          badge.textContent = value;
          if (value === 'Approved') badge.style.cssText = 'background: rgba(81, 207, 102, 0.15); color: #51cf66;';
          else if (value === 'Needs Changes') badge.style.cssText = 'background: rgba(255, 146, 43, 0.15); color: #ff922b;';
          else if (value === 'Rejected') badge.style.cssText = 'background: rgba(224, 17, 95, 0.15); color: #E0115F;';
          valueDiv.appendChild(badge);
        } else {
          // For compact view (timeline), truncate long text
          if (compact && value.length > 100) {
            valueDiv.textContent = value.substring(0, 100) + '...';
          } else {
            valueDiv.textContent = value;
          }
        }
        
        item.appendChild(valueDiv);
        container.appendChild(item);
      });
      
      return container.children.length > 0 ? container : null;
    }
    
    // Render Functions
    function renderMoments() {
      const container = document.getElementById('momentsList');
      
      let filteredMoments;
      if (state.selectedThread === 'unthreaded') {
        filteredMoments = state.moments.filter(m => !m.threadId);
      } else if (state.selectedThread) {
        filteredMoments = state.moments.filter(m => m.threadId === state.selectedThread);
      } else {
        filteredMoments = state.moments;
      }
      
      if (state.filterType !== 'all') {
        filteredMoments = filteredMoments.filter(m => m.type === state.filterType);
      }
      
      const displayMoments = state.view === 'search' && state.searchResults.length > 0
        ? state.searchResults
        : filteredMoments;
      
      if (displayMoments.length === 0) {
        if (state.selectedThread === 'unthreaded') {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon"><svg class="icon-context" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" x2="12" y1="17" y2="22"/><path d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V6h1a2 2 0 0 0 0-4H8a2 2 0 0 0 0 4h1v4.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24Z"/></svg></div>
              <h3>No unthreaded moments</h3>
              <p>All moments are assigned to threads</p>
            </div>
          `;
        } else if (state.selectedThread) {
          const thread = state.threads.find(t => t.id === state.selectedThread);
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon"><svg class="icon-context" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 17h.01"/><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/></svg></div>
              <h3>No moments in this thread</h3>
              <p>Capture a moment to add it to "${thread ? thread.name : 'this thread'}"</p>
            </div>
          `;
        } else {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon"></div>
              <h3>No moments yet</h3>
              <p>Capture your first moment to get started</p>
            </div>
          `;
        }
        return;
      }
      
      container.innerHTML = '';
      displayMoments.forEach(moment => {
        const config = MOMENT_TYPES[moment.type];
        const card = document.createElement('div');
        card.className = 'moment-card';
        if (state.selectedMoment?.id === moment.id) {
          card.classList.add('selected');
        }
        card.style.borderLeftColor = config.color;
        
        let contextHtml = '';
        if (moment.context.service || moment.context.environment || moment.context.version) {
          contextHtml = '<div class="moment-context">';
          if (moment.context.service) contextHtml += `<div class="context-tag"><svg class="icon-context" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg> ${moment.context.service}</div>`;
          if (moment.context.environment) contextHtml += `<div class="context-tag"><svg class="icon-context" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg> ${moment.context.environment}</div>`;
          if (moment.context.version) contextHtml += `<div class="context-tag"><svg class="icon-context" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" x2="7.01" y1="7" y2="7"/></svg> ${moment.context.version}</div>`;
          contextHtml += '</div>';
        }
        
        let threadBadge = '';
        if (moment.threadId && !state.selectedThread) {
          const thread = state.threads.find(t => t.id === moment.threadId);
          if (thread) {
            threadBadge = `<div class="moment-thread-badge"><svg class="icon-context" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 17h.01"/><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/></svg> ${thread.name}</div>`;
          }
        } else if (!moment.threadId && state.threads.length > 0 && !state.selectedThread) {
          threadBadge = `<div class="moment-unthreaded-badge"><svg class="icon-context" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" x2="12" y1="17" y2="22"/><path d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V6h1a2 2 0 0 0 0-4H8a2 2 0 0 0 0 4h1v4.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24Z"/></svg> Unthreaded</div>`;
        }
        
        let priorityHtml = '';
        if (moment.priority) {
          const priorityIcons = { critical: `<svg class="icon-priority" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10" fill="#E0115F"/></svg>`, 'follow-up': `<svg class="icon-priority" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10" fill="#ff922b"/></svg>`, pinned: `<svg class="icon-priority" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" fill="#ffd700"/></svg>` };
          const priorityLabels = { critical: 'Critical', 'follow-up': 'Follow-up', pinned: 'Pinned' };
          priorityHtml = `<div class="moment-priority"><span class="priority-badge ${moment.priority}">${priorityIcons[moment.priority]} ${priorityLabels[moment.priority]}</span></div>`;
        }
        
        card.innerHTML = `
          ${threadBadge}
          ${priorityHtml}
          <div class="moment-header">
            <div class="moment-type" style="color: ${config.color}">
              ${config.icon} ${config.label}
            </div>
            <div class="moment-time">${formatTime(moment.timestamp)}</div>
          </div>
          <div class="moment-text">${parseMarkdown(moment.text)}</div>
          ${contextHtml}
        `;
        
        if (moment.tags && moment.tags.length > 0) {
          const tagsContainer = document.createElement('div');
          tagsContainer.className = 'moment-tags';
          moment.tags.forEach(tag => {
            const tagEl = document.createElement('span');
            tagEl.className = 'moment-tag';
            tagEl.textContent = '#' + tag;
            tagEl.style.cursor = 'default';
            tagsContainer.appendChild(tagEl);
          });
          card.appendChild(tagsContainer);
        }
        
        if (moment.templateData && config.template) {
          const templateDisplay = createTemplateDisplay(moment.templateData, config.template, true);
          if (templateDisplay) {
            card.appendChild(templateDisplay);
          }
        }
        
        if (moment.charts && moment.charts.length > 0) {
          const chartsContainer = document.createElement('div');
          chartsContainer.className = 'moment-charts';
          moment.charts.forEach(chart => {
            chartsContainer.appendChild(createChart(
              chart.title || chart.type, 
              chart.data, 
              config.color, 
              chart.labels || null, 
              chart.id || null, 
              chart.chartType || 'line'
            ));
          });
          card.appendChild(chartsContainer);
        }
        
        if (moment.codeBlocks && moment.codeBlocks.length > 0) {
          const codeContainer = document.createElement('div');
          codeContainer.className = 'moment-code-blocks';
          moment.codeBlocks.forEach(codeBlock => {
            codeContainer.appendChild(createCodeBlock(codeBlock.language, codeBlock.code, codeBlock.title || '', null));
          });
          card.appendChild(codeContainer);
        }
        
        if (moment.tables && moment.tables.length > 0) {
          const tableContainer = document.createElement('div');
          tableContainer.className = 'moment-tables';
          moment.tables.forEach(table => {
            tableContainer.appendChild(createTable(table.title || '', table.data, null));
          });
          card.appendChild(tableContainer);
        }
        
        if (moment.attachments && moment.attachments.length > 0) {
          const attachmentsContainer = document.createElement('div');
          attachmentsContainer.className = 'moment-attachments';
          moment.attachments.forEach(attachment => {
            const preview = document.createElement('div');
            preview.className = 'attachment-preview';
            
            if (attachment.isImage) {
              preview.innerHTML = `<img src="${attachment.data}" alt="${attachment.name}">`;
              preview.addEventListener('click', (e) => {
                e.stopPropagation();
                showImageModal(attachment.data);
              });
            } else {
              preview.innerHTML = `<div class="attachment-file"><svg class="icon-context" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg></div>`;
              preview.addEventListener('click', (e) => {
                e.stopPropagation();
                downloadAttachment(attachment);
              });
            }
            
            attachmentsContainer.appendChild(preview);
          });
          card.appendChild(attachmentsContainer);
        }
        
        card.addEventListener('click', () => {
          state.selectedMoment = moment;
          document.querySelectorAll('.moment-card').forEach(c => c.classList.remove('selected'));
          card.classList.add('selected');
          renderDetail();
        });
        
        container.appendChild(card);
      });
    }
    
    function renderDetail() {
      const panel = document.getElementById('detailPanel');
      
      if (!state.selectedMoment) {
        panel.classList.remove('visible');
        return;
      }
      
      panel.classList.add('visible');
      const moment = state.selectedMoment;
      const config = MOMENT_TYPES[moment.type];
      
      let editButtonHtml = `
        <button class="btn-secondary" onclick="editMoment('${moment.id}')" style="width: 100%; margin-bottom: 12px;">
          <svg class="icon-action" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.12 2.12 0 0 1 3 3L12 15l-4 1 1-4Z"/></svg> Edit Moment
        </button>
      `;
      
      let deleteButtonHtml = `
        <button class="btn-danger" onclick="confirmDeleteMoment('${moment.id}')" style="margin-bottom: 16px;">
          <svg class="icon-action" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg> Delete Moment
        </button>
      `;
      
      let threadAssignmentHtml = '';
      const momentThread = moment.threadId ? state.threads.find(t => t.id === moment.threadId) : null;
      
      if (state.threads.length > 0) {
        threadAssignmentHtml = `
          <div class="thread-assignment">
            <div class="thread-assignment-header">
              <span class="thread-assignment-label"><svg class="icon-context" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 17h.01"/><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/></svg> Thread</span>
              ${momentThread ? `<button class="thread-remove-btn" onclick="removeFromThread('${moment.id}')"></button>` : ''}
            </div>
            <select class="thread-select" onchange="assignToThread('${moment.id}', this.value)">
              <option value="">No thread</option>
              ${state.threads.map(t => `
                <option value="${t.id}" ${t.id === moment.threadId ? 'selected' : ''}>
                  ${t.name}
                </option>
              `).join('')}
            </select>
          </div>
        `;
      }
      
      let contextHtml = '';
      if (moment.context.service || moment.context.environment || moment.context.version) {
        contextHtml = '<div class="detail-section"><h3>Context</h3><div class="context-grid">';
        if (moment.context.service) {
          contextHtml += `
            <div class="context-item">
              <div class="context-item-label">Service</div>
              <div class="context-item-value">${moment.context.service}</div>
            </div>
          `;
        }
        if (moment.context.environment) {
          contextHtml += `
            <div class="context-item">
              <div class="context-item-label">Environment</div>
              <div class="context-item-value">${moment.context.environment}</div>
            </div>
          `;
        }
        if (moment.context.version) {
          contextHtml += `
            <div class="context-item">
              <div class="context-item-label">Version</div>
              <div class="context-item-value">${moment.context.version}</div>
            </div>
          `;
        }
        contextHtml += '</div></div>';
      }
      
      panel.innerHTML = `
        ${editButtonHtml}
        ${deleteButtonHtml}
        ${threadAssignmentHtml}
        <div class="detail-header">
          <div class="detail-type-icon" style="color: ${config.color}">
            ${config.icon}
          </div>
          <div class="detail-meta">
            <h2>${config.label}</h2>
            <div class="detail-timestamp">${new Date(moment.timestamp).toLocaleString()}</div>
          </div>
        </div>
        
        <div class="detail-section">
          <h3>Thought</h3>
          <div class="detail-content">${parseMarkdown(moment.text)}</div>
        </div>
        
        ${contextHtml}
      `;
      
      if (moment.priority) {
        const section = document.createElement('div');
        section.className = 'detail-section';
        section.innerHTML = '<h3>Priority</h3>';
        const priorityIcons = { critical: `<svg class="icon-priority" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10" fill="#E0115F"/></svg>`, 'follow-up': `<svg class="icon-priority" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10" fill="#ff922b"/></svg>`, pinned: `<svg class="icon-priority" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" fill="#ffd700"/></svg>` };
        const priorityLabels = { critical: 'Critical', 'follow-up': 'Follow-up Required', pinned: 'Pinned' };
        const badge = document.createElement('span');
        badge.className = `priority-badge ${moment.priority}`;
        badge.innerHTML = `${priorityIcons[moment.priority]} ${priorityLabels[moment.priority]}`;
        section.appendChild(badge);
        panel.appendChild(section);
      }
      
      if (moment.tags && moment.tags.length > 0) {
        const section = document.createElement('div');
        section.className = 'detail-section';
        section.innerHTML = '<h3>Tags</h3>';
        const tagsContainer = document.createElement('div');
        tagsContainer.className = 'moment-tags';
        moment.tags.forEach(tag => {
          const tagEl = document.createElement('span');
          tagEl.className = 'moment-tag';
          tagEl.textContent = '#' + tag;
          tagEl.style.cursor = 'default';
          tagsContainer.appendChild(tagEl);
        });
        section.appendChild(tagsContainer);
        panel.appendChild(section);
      }
      
      if (moment.templateData && config.template) {
        const section = document.createElement('div');
        section.className = 'detail-section';
        section.innerHTML = '<h3>Details</h3>';
        const templateDisplay = createTemplateDisplay(moment.templateData, config.template, false);
        if (templateDisplay) {
          section.appendChild(templateDisplay);
          panel.appendChild(section);
        }
      }
      
      if (moment.charts && moment.charts.length > 0) {
        const section = document.createElement('div');
        section.className = 'detail-section';
        section.innerHTML = '<h3>Signals</h3>';
        const chartsContainer = document.createElement('div');
        chartsContainer.style.display = 'flex';
        chartsContainer.style.flexDirection = 'column';
        chartsContainer.style.gap = '12px';
        
        moment.charts.forEach(chart => {
          chartsContainer.appendChild(createChart(
            chart.title || chart.type, 
            chart.data, 
            config.color, 
            chart.labels || null, 
            chart.id || null, 
            chart.chartType || 'line'
          ));
        });
        
        section.appendChild(chartsContainer);
        panel.appendChild(section);
      }
      
      if (moment.codeBlocks && moment.codeBlocks.length > 0) {
        const section = document.createElement('div');
        section.className = 'detail-section';
        section.innerHTML = '<h3>Code</h3>';
        const codeContainer = document.createElement('div');
        codeContainer.style.display = 'flex';
        codeContainer.style.flexDirection = 'column';
        codeContainer.style.gap = '12px';
        
        moment.codeBlocks.forEach(codeBlock => {
          codeContainer.appendChild(createCodeBlock(codeBlock.language, codeBlock.code, codeBlock.title || '', null));
        });
        
        section.appendChild(codeContainer);
        panel.appendChild(section);
      }
      
      if (moment.tables && moment.tables.length > 0) {
        const section = document.createElement('div');
        section.className = 'detail-section';
        section.innerHTML = '<h3>Tables</h3>';
        const tableContainer = document.createElement('div');
        tableContainer.style.display = 'flex';
        tableContainer.style.flexDirection = 'column';
        tableContainer.style.gap = '12px';
        
        moment.tables.forEach(table => {
          tableContainer.appendChild(createTable(table.title || '', table.data, null));
        });
        
        section.appendChild(tableContainer);
        panel.appendChild(section);
      }
      
      if (moment.attachments && moment.attachments.length > 0) {
        const section = document.createElement('div');
        section.className = 'detail-section';
        section.innerHTML = '<h3>Attachments</h3>';
        const attachmentsContainer = document.createElement('div');
        attachmentsContainer.style.display = 'flex';
        attachmentsContainer.style.flexDirection = 'column';
        attachmentsContainer.style.gap = '12px';
        
        moment.attachments.forEach(attachment => {
          if (attachment.isImage) {
            const preview = document.createElement('div');
            preview.className = 'attachment-preview-large';
            preview.innerHTML = `<img src="${attachment.data}" alt="${attachment.name}" style="cursor: pointer;">`;
            preview.addEventListener('click', () => showImageModal(attachment.data));
            attachmentsContainer.appendChild(preview);
          } else {
            const fileItem = document.createElement('div');
            fileItem.style.cssText = 'display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(0, 0, 0, 0.2); border-radius: 6px; cursor: pointer; transition: all 0.2s;';
            fileItem.innerHTML = `
              <div style="font-size: 32px;"><svg class="icon-context" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg></div>
              <div style="flex: 1;">
                <div style="font-size: 13px; font-weight: 600; color: var(--text-primary);">${attachment.name}</div>
                <div style="font-size: 11px; color: var(--text-muted);">${(attachment.size / 1024).toFixed(1)} KB</div>
              </div>
              <div style="font-size: 20px; color: var(--accent-primary);"><svg class="icon-action" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg></div>
            `;
            fileItem.addEventListener('click', () => downloadAttachment(attachment));
            fileItem.addEventListener('mouseover', () => fileItem.style.background = 'rgba(0, 212, 255, 0.1)');
            fileItem.addEventListener('mouseout', () => fileItem.style.background = 'rgba(0, 0, 0, 0.2)');
            attachmentsContainer.appendChild(fileItem);
          }
        });
        
        section.appendChild(attachmentsContainer);
        panel.appendChild(section);
      }
      
      // Add backlinks section
      const { outgoing, incoming } = getLinkedMoments(moment.id);
      if (outgoing.length > 0 || incoming.length > 0) {
        const linksSection = document.createElement('div');
        linksSection.className = 'detail-section';
        linksSection.innerHTML = '<h3><svg class="icon-context" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg> Links & Backlinks</h3>';
        
        if (outgoing.length > 0) {
          const outgoingDiv = document.createElement('div');
          outgoingDiv.style.marginBottom = '12px';
          outgoingDiv.innerHTML = '<h4 style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">Links To:</h4>';
          outgoing.forEach(m => {
            const cfg = MOMENT_TYPES[m.type];
            const linkItem = document.createElement('div');
            linkItem.className = 'graph-link-item';
            linkItem.textContent = `${cfg.icon} ${m.text.substring(0, 60)}...`;
            linkItem.onclick = () => navigateToMoment(m.id);
            outgoingDiv.appendChild(linkItem);
          });
          linksSection.appendChild(outgoingDiv);
        }
        
        if (incoming.length > 0) {
          const incomingDiv = document.createElement('div');
          incomingDiv.innerHTML = '<h4 style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">Linked From (Backlinks):</h4>';
          incoming.forEach(m => {
            const cfg = MOMENT_TYPES[m.type];
            const linkItem = document.createElement('div');
            linkItem.className = 'graph-link-item';
            linkItem.textContent = `${cfg.icon} ${m.text.substring(0, 60)}...`;
            linkItem.onclick = () => navigateToMoment(m.id);
            incomingDiv.appendChild(linkItem);
          });
          linksSection.appendChild(incomingDiv);
        }
        
        panel.appendChild(linksSection);
      }
    }
    
    function renderThreads() {
      const container = document.getElementById('threadList');
      container.innerHTML = '';
      
      state.threads.forEach(thread => {
        const threadMoments = state.moments.filter(m => m.threadId === thread.id);
        const item = document.createElement('div');
        item.className = 'thread-item';
        if (state.selectedThread === thread.id) {
          item.classList.add('active');
        }
        
        item.innerHTML = `
          <div class="thread-name">${thread.name}</div>
          <div class="thread-meta">${threadMoments.length} moment${threadMoments.length !== 1 ? 's' : ''}</div>
        `;
        
        item.addEventListener('click', () => {
          state.selectedThread = state.selectedThread === thread.id ? null : thread.id;
          state.view = 'timeline';
          render();
        });
        
        container.appendChild(item);
      });
    }
    
    function updateCounts() {
      let momentsToCount;
      if (state.selectedThread === 'unthreaded') {
        momentsToCount = state.moments.filter(m => !m.threadId);
      } else if (state.selectedThread) {
        momentsToCount = state.moments.filter(m => m.threadId === state.selectedThread);
      } else {
        momentsToCount = state.moments;
      }
      
      document.getElementById('count-all').textContent = momentsToCount.length;
      Object.keys(MOMENT_TYPES).forEach(type => {
        const count = momentsToCount.filter(m => m.type === type).length;
        document.getElementById(`count-${type}`).textContent = count;
      });
      
      const unthreadedCount = state.moments.filter(m => !m.threadId).length;
      document.getElementById('count-unthreaded').textContent = unthreadedCount;
    }
    
    
    // Render Graph Visualization
    function renderGraph() {
      const container = document.getElementById('graphContainer');
      container.innerHTML = '';
      
      if (state.moments.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon"></div><h3>No Moments Yet</h3><p>Create moments with [[wikilinks]] to build your knowledge graph</p></div>';
        return;
      }
      
      // Build nodes and links
      const nodes = state.moments.map(m => ({
        id: m.id,
        label: m.text.substring(0, 30).replace(/\n/g, ' ') + (m.text.length > 30 ? '...' : ''),
        type: m.type,
        moment: m
      }));
      
      const links = [];
      const linkSet = new Set();
      
      state.moments.forEach(moment => {
        const wikilinks = extractWikilinks(moment.text);
        wikilinks.forEach(linkText => {
          const targetMoment = state.moments.find(m => 
            m.text.substring(0, 50).toLowerCase().includes(linkText.toLowerCase()) ||
            m.id === linkText
          );
          if (targetMoment) {
            const linkKey = `${moment.id}-${targetMoment.id}`;
            if (!linkSet.has(linkKey)) {
              links.push({ source: moment.id, target: targetMoment.id });
              linkSet.add(linkKey);
            }
          }
        });
      });
      
      const width = container.clientWidth;
      const height = container.clientHeight;
      
      const svg = d3.select(container)
        .append('svg')
        .attr('width', width)
        .attr('height', height);
      
      // Add zoom behavior
      const g = svg.append('g');
      
      svg.call(d3.zoom()
        .scaleExtent([0.1, 4])
        .on('zoom', (event) => {
          g.attr('transform', event.transform);
        }));
      
      // Create force simulation
      const simulation = d3.forceSimulation(nodes)
        .force('link', d3.forceLink(links).id(d => d.id).distance(100))
        .force('charge', d3.forceManyBody().strength(-300))
        .force('center', d3.forceCenter(width / 2, height / 2))
        .force('collision', d3.forceCollide().radius(40));
      
      // Draw links
      const link = g.append('g')
        .selectAll('line')
        .data(links)
        .join('line')
        .attr('class', 'graph-link')
        .attr('stroke', 'rgba(255, 255, 255, 0.15)')
        .attr('stroke-width', 1.5);
      
      // Draw nodes
      const node = g.append('g')
        .selectAll('g')
        .data(nodes)
        .join('g')
        .attr('class', 'graph-node')
        .call(d3.drag()
          .on('start', dragstarted)
          .on('drag', dragged)
          .on('end', dragended))
        .on('click', (event, d) => {
          event.stopPropagation();
          showGraphNodeDetails(d.moment);
          
          // Highlight connected nodes
          node.classed('selected', n => n.id === d.id);
          link.classed('highlighted', l => 
            l.source.id === d.id || l.target.id === d.id
          );
        });
      
      // Add circles to nodes
      node.append('circle')
        .attr('r', 20)
        .attr('fill', d => {
          const config = MOMENT_TYPES[d.type];
          return config ? config.color : '#64748b';
        })
        .attr('opacity', 0.8);
      
      // Add labels to nodes
      node.append('text')
        .text(d => d.label)
        .attr('x', 0)
        .attr('y', 30)
        .attr('text-anchor', 'middle')
        .attr('fill', '#e4e4e7')
        .attr('font-size', '11px');
      
      // Update positions on simulation tick
      simulation.on('tick', () => {
        link
          .attr('x1', d => d.source.x)
          .attr('y1', d => d.source.y)
          .attr('x2', d => d.target.x)
          .attr('y2', d => d.target.y);
        
        node.attr('transform', d => `translate(${d.x},${d.y})`);
      });
      
      function dragstarted(event) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        event.subject.fx = event.subject.x;
        event.subject.fy = event.subject.y;
      }
      
      function dragged(event) {
        event.subject.fx = event.x;
        event.subject.fy = event.y;
      }
      
      function dragended(event) {
        if (!event.active) simulation.alphaTarget(0);
        event.subject.fx = null;
        event.subject.fy = null;
      }
    }
    
    // Show graph node details
    function showGraphNodeDetails(moment) {
      const panel = document.getElementById('graphDetailPanel');
      
      if (!moment) {
        panel.classList.remove('visible');
        return;
      }
      
      // Just call the same rendering logic as timeline detail panel
      panel.classList.add('visible');
      
      // Temporarily set this as selected moment for rendering
      const originalSelected = state.selectedMoment;
      state.selectedMoment = moment;
      
      // Render using the same logic, but to the graph detail panel
      const config = MOMENT_TYPES[moment.type];
      
      let editButtonHtml = `
        <button class="btn-secondary" onclick="editMoment('${moment.id}')" style="width: 100%; margin-bottom: 12px;">
          <svg class="icon-action" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.12 2.12 0 0 1 3 3L12 15l-4 1 1-4Z"/></svg> Edit Moment
        </button>
      `;
      
      let deleteButtonHtml = `
        <button class="btn-danger" onclick="confirmDeleteMoment('${moment.id}')" style="margin-bottom: 16px;">
          <svg class="icon-action" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg> Delete Moment
        </button>
      `;
      
      panel.innerHTML = editButtonHtml + deleteButtonHtml;
      
      // Restore original selected moment
      state.selectedMoment = originalSelected;
      
      // Now render full details by copying logic from renderDetail
      const detailPanel = document.getElementById('detailPanel');
      if (detailPanel) {
        // Temporarily swap the panel reference
        const tempHTML = detailPanel.innerHTML;
        state.selectedMoment = moment;
        renderDetail();
        panel.innerHTML = detailPanel.innerHTML;
        detailPanel.innerHTML = tempHTML;
        state.selectedMoment = originalSelected;
      }
    }
    
    function render() {
      document.getElementById('timelineView').classList.toggle('hidden', state.view !== 'timeline');
      document.getElementById('captureView').classList.toggle('visible', state.view === 'capture');
      document.getElementById('searchView').classList.toggle('visible', state.view === 'search');
      document.getElementById('graphView').classList.toggle('visible', state.view === 'graph');
      
      if (state.view === 'graph') {
        renderGraph();
      }
      
      if (state.view === 'capture') {
        const threadIndicator = document.getElementById('captureThreadIndicator');
        
        if (state.editingMoment) {
          document.getElementById('captureTitle').textContent = 'Edit Moment';
          const timestamp = new Date(state.editingMoment.timestamp).toLocaleString();
          document.getElementById('captureSubtitle').textContent = `Original timestamp: ${timestamp}`;
        } else {
          document.getElementById('captureTitle').textContent = 'Capture a Moment';
          document.getElementById('captureSubtitle').textContent = 'What are you thinking right now?';
        }
        
        if (state.selectedThread && !state.editingMoment) {
          const thread = state.threads.find(t => t.id === state.selectedThread);
          if (thread) {
            threadIndicator.classList.remove('hidden');
            threadIndicator.innerHTML = `<svg class="icon-context" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 17h.01"/><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/></svg> Adding to thread: <strong>${thread.name}</strong>`;
          }
        } else {
          threadIndicator.classList.add('hidden');
        }
        
        const threadSelect = document.getElementById('captureThreadSelect');
        threadSelect.innerHTML = '<option value="">No thread</option>';
        state.threads.forEach(thread => {
          const option = document.createElement('option');
          option.value = thread.id;
          option.textContent = thread.name;
          if (state.selectedThread === thread.id) {
            option.selected = true;
          }
          threadSelect.appendChild(option);
        });
      }
      
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.toggle('active', item.dataset.view === state.view);
      });
      
      document.querySelectorAll('.filter-item').forEach(item => {
        item.classList.toggle('active', item.dataset.filter === state.filterType);
      });
      
      const titleEl = document.getElementById('timelineTitle');
      const threadBanner = document.getElementById('threadBanner');
      const threadBannerText = document.getElementById('threadBannerText');
      const threadBannerDeleteBtn = document.getElementById('threadBannerDeleteBtn');
      
      if (!state.filterType || (state.filterType !== 'all' && !MOMENT_TYPES[state.filterType])) {
        state.filterType = 'all';
      }
      
      if (state.selectedThread === 'unthreaded') {
        const unthreadedMoments = state.moments.filter(m => !m.threadId);
        
        if (state.filterType === 'all') {
          titleEl.textContent = `Unthreaded Moments (${unthreadedMoments.length})`;
        } else {
          const count = unthreadedMoments.filter(m => m.type === state.filterType).length;
          titleEl.textContent = `${MOMENT_TYPES[state.filterType].label} (${count})`;
        }
        
        threadBanner.classList.remove('hidden');
        threadBannerText.textContent = 'Viewing unthreaded moments';
        threadBannerDeleteBtn.style.display = 'none';
      } else if (state.selectedThread) {
        const thread = state.threads.find(t => t.id === state.selectedThread);
        const threadMoments = state.moments.filter(m => m.threadId === state.selectedThread);
        
        if (state.filterType === 'all') {
          titleEl.textContent = `All Moments (${threadMoments.length})`;
        } else {
          const count = threadMoments.filter(m => m.type === state.filterType).length;
          titleEl.textContent = `${MOMENT_TYPES[state.filterType].label} (${count})`;
        }
        
        if (thread) {
          threadBanner.classList.remove('hidden');
          threadBannerText.textContent = `Viewing thread: ${thread.name}`;
          threadBannerDeleteBtn.style.display = '';
        }
      } else {
        threadBanner.classList.add('hidden');
        
        if (state.filterType === 'all') {
          titleEl.textContent = `All Moments (${state.moments.length})`;
        } else {
          const count = state.moments.filter(m => m.type === state.filterType).length;
          titleEl.textContent = `${MOMENT_TYPES[state.filterType].label} (${count})`;
        }
      }
      
      const unthreadedFilter = document.getElementById('unthreadedFilter');
      if (state.threads.length > 0) {
        unthreadedFilter.classList.remove('hidden');
        unthreadedFilter.classList.toggle('active', state.selectedThread === 'unthreaded');
      } else {
        unthreadedFilter.classList.add('hidden');
      }
      
      renderMoments();
      renderDetail();
      renderThreads();
      updateCounts();
    }
    
    // Event Handlers
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', () => {
        state.view = item.dataset.view;
        render();
      });
    });
    
    document.querySelectorAll('.filter-item').forEach(item => {
      item.addEventListener('click', () => {
        state.filterType = item.dataset.filter;
        render();
      });
    });
    
    document.getElementById('captureMomentBtn').addEventListener('click', () => {
      state.view = 'capture';
      state.editingMoment = null;
      document.getElementById('submitCaptureBtn').innerHTML = '<svg class="icon-action" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg> Capture Moment';
      render();
    });
    
    // Theme Toggle
    const themeNames = {
      'classic': 'Ruby Classic',
      'ruby-noir': 'Ruby Noir',
      'ruby-twilight': 'Ruby Twilight',
      'ruby-forest': 'Ruby Forest',
      'ruby-ocean': 'Ruby Ocean',
      'ruby-ember': 'Ruby Ember',
      'ruby-slate': 'Ruby Slate',
      'ruby-midnight': 'Ruby Midnight',
      'ruby-crimson': 'Ruby Crimson',
      'ruby-cosmic': 'Ruby Cosmic'
    };
    
    function loadTheme() {
      const savedTheme = localStorage.getItem('ruby-theme') || 'classic';
      applyTheme(savedTheme);
    }
    
    function applyTheme(theme) {
      if (theme === 'classic') {
        document.documentElement.removeAttribute('data-theme');
      } else {
        document.documentElement.setAttribute('data-theme', theme);
      }
      
      document.getElementById('currentThemeName').textContent = themeNames[theme] || 'Classic';
      
      document.querySelectorAll('.theme-option').forEach(option => {
        option.classList.toggle('active', option.dataset.theme === theme);
      });
      
      localStorage.setItem('ruby-theme', theme);
    }
    
    document.getElementById('themeToggle').addEventListener('click', (e) => {
      e.stopPropagation();
      document.getElementById('themeDropdown').classList.toggle('visible');
    });
    
    document.querySelectorAll('.theme-option').forEach(option => {
      option.addEventListener('click', (e) => {
        e.stopPropagation();
        const theme = option.dataset.theme;
        applyTheme(theme);
        document.getElementById('themeDropdown').classList.remove('visible');
      });
    });
    
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.theme-selector')) {
        document.getElementById('themeDropdown').classList.remove('visible');
      }
    });
    
    loadTheme();
    
    document.getElementById('newThreadBtn').addEventListener('click', () => {
      const name = prompt('Thread name:');
      if (!name) return;
      
      const newThread = {
        id: generateId(),
        name,
        created: Date.now(),
        momentIds: []
      };
      
      state.threads.unshift(newThread);
      state.selectedThread = newThread.id;
      saveData();
      render();
    });
    
    document.getElementById('unthreadedFilter').addEventListener('click', () => {
      state.selectedThread = state.selectedThread === 'unthreaded' ? null : 'unthreaded';
      state.view = 'timeline';
      render();
    });
    
    document.querySelectorAll('.type-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        state.captureType = btn.dataset.type;
        
        const config = MOMENT_TYPES[state.captureType];
        const placeholder = config.prompts[0] || "What's on your mind?";
        document.getElementById('captureText').placeholder = placeholder;
        
        renderTemplateFields(state.captureType);
      });
    });
    
    function renderTemplateFields(type) {
      const config = MOMENT_TYPES[type];
      const container = document.getElementById('templateFieldsContainer');
      const wrapper = document.getElementById('templateFields');
      
      if (!config.template || config.template.length === 0) {
        wrapper.style.display = 'none';
        container.innerHTML = '';
        return;
      }
      
      wrapper.style.display = 'block';
      container.innerHTML = '';
      
      config.template.forEach(field => {
        const fieldDiv = document.createElement('div');
        fieldDiv.className = 'template-field';
        
        const label = document.createElement('label');
        label.className = 'template-field-label';
        label.textContent = field.label;
        fieldDiv.appendChild(label);
        
        if (field.type === 'text') {
          const input = document.createElement('input');
          input.className = 'form-input';
          input.placeholder = field.placeholder || '';
          input.dataset.templateField = field.name;
          fieldDiv.appendChild(input);
        } else if (field.type === 'textarea') {
          const textarea = document.createElement('textarea');
          textarea.className = 'template-field-textarea';
          textarea.placeholder = field.placeholder || '';
          textarea.dataset.templateField = field.name;
          fieldDiv.appendChild(textarea);
        } else if (field.type === 'select') {
          const select = document.createElement('select');
          select.className = 'form-input';
          select.dataset.templateField = field.name;
          
          const emptyOption = document.createElement('option');
          emptyOption.value = '';
          emptyOption.textContent = 'Select...';
          select.appendChild(emptyOption);
          
          field.options.forEach(option => {
            const opt = document.createElement('option');
            opt.value = option;
            opt.textContent = option;
            select.appendChild(opt);
          });
          
          fieldDiv.appendChild(select);
        }
        
        container.appendChild(fieldDiv);
      });
    }
    
    
    document.getElementById('addChartBtn').addEventListener('click', () => {
      document.getElementById('chartModal').classList.add('visible');
      document.getElementById('modalChartType').value = 'line';
      document.getElementById('modalChartTitle').value = '';
      document.getElementById('modalChartData').value = '';
      document.getElementById('modalChartLabels').value = '';
    });
    
    document.getElementById('addCodeBtn').addEventListener('click', () => {
      document.getElementById('codeModal').classList.add('visible');
      document.getElementById('modalCodeLanguage').value = 'javascript';
      document.getElementById('modalCodeTitle').value = '';
      document.getElementById('modalCodeContent').value = '';
    });
    
    document.getElementById('addFileBtn').addEventListener('click', () => {
      document.getElementById('fileInput').click();
    });
    
    document.getElementById('fileInput').addEventListener('change', async (e) => {
      const files = Array.from(e.target.files);
      
      for (const file of files) {
        const reader = new FileReader();
        
        reader.onload = (event) => {
          const attachment = {
            id: `file-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
            name: file.name,
            type: file.type,
            size: file.size,
            data: event.target.result,
            isImage: file.type.startsWith('image/')
          };
          
          state.captureAttachments.push(attachment);
          renderAttachmentPreview(attachment);
        };
        
        reader.readAsDataURL(file);
      }
      
      e.target.value = '';
    });
    
    function renderAttachmentPreview(attachment) {
      const container = document.getElementById('attachmentsPreview');
      const item = document.createElement('div');
      item.className = 'attachment-item';
      item.dataset.attachmentId = attachment.id;
      
      if (attachment.isImage) {
        item.innerHTML = `
          <div class="attachment-preview">
            <img src="${attachment.data}" alt="${attachment.name}">
            <button class="attachment-remove" onclick="removeAttachment('${attachment.id}')"></button>
          </div>
        `;
      } else {
        item.innerHTML = `
          <div class="attachment-preview">
            <div class="attachment-file"><svg class="icon-context" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg></div>
            <button class="attachment-remove" onclick="removeAttachment('${attachment.id}')"></button>
          </div>
          <div style="font-size: 10px; color: var(--text-secondary); margin-top: 4px; max-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${attachment.name}</div>
        `;
      }
      
      container.appendChild(item);
    }
    
    window.removeAttachment = function(attachmentId) {
      const index = state.captureAttachments.findIndex(a => a.id === attachmentId);
      if (index !== -1) {
        state.captureAttachments.splice(index, 1);
      }
      
      const element = document.querySelector(`[data-attachment-id="${attachmentId}"]`);
      if (element) {
        element.remove();
      }
    };
    
    // Tags functionality
    const AUTO_TAG_KEYWORDS = {
      'latency': ['latency', 'slow', 'performance', 'timeout', 'delay'],
      'ui': ['ui', 'ux', 'interface', 'design', 'layout', 'button', 'form'],
      'customer-impact': ['customer', 'user', 'client', 'production', 'outage', 'down'],
      'database': ['database', 'db', 'sql', 'query', 'postgres', 'mysql'],
      'api': ['api', 'endpoint', 'rest', 'graphql', 'request', 'response'],
      'security': ['security', 'auth', 'authentication', 'permission', 'vulnerability'],
      'performance': ['performance', 'optimization', 'cache', 'speed', 'memory'],
      'bug': ['bug', 'error', 'issue', 'broken', 'crash', 'fail']
    };
    
    function autoTagText(text) {
      const autoTags = [];
      const lowerText = text.toLowerCase();
      
      for (const [tag, keywords] of Object.entries(AUTO_TAG_KEYWORDS)) {
        for (const keyword of keywords) {
          if (lowerText.includes(keyword)) {
            autoTags.push(tag);
            break;
          }
        }
      }
      
      return [...new Set(autoTags)];
    }
    
    function renderTag(tag, isAuto = false) {
      const tagEl = document.createElement('span');
      tagEl.className = `moment-tag ${isAuto ? 'auto-tag' : ''}`;
      tagEl.innerHTML = `${isAuto ? '<svg class="icon-context" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg> ' : ''}#${tag} <span class="tag-remove" onclick="removeTag('${tag}')"></span>`;
      return tagEl;
    }
    
    window.removeTag = function(tag) {
      const index = state.captureTags.indexOf(tag);
      if (index !== -1) {
        state.captureTags.splice(index, 1);
        renderTagsDisplay();
      }
    };
    
    function renderTagsDisplay() {
      const container = document.getElementById('tagsDisplay');
      container.innerHTML = '';
      state.captureTags.forEach(tag => {
        container.appendChild(renderTag(tag));
      });
    }
    
    document.getElementById('tagsInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        const input = e.target;
        let tag = input.value.trim().toLowerCase();
        
        if (!tag) return;
        
        // Remove # if user added it
        tag = tag.replace(/^#/, '');
        
        // Add tag if not already present
        if (tag && !state.captureTags.includes(tag)) {
          state.captureTags.push(tag);
          renderTagsDisplay();
        }
        
        input.value = '';
      }
    });
    
    // Auto-tag when text changes
    document.getElementById('captureText').addEventListener('input', (e) => {
      const text = e.target.value;
      const autoTags = autoTagText(text);
      
      // Add auto-tags that aren't already in the list
      autoTags.forEach(tag => {
        if (!state.captureTags.includes(tag)) {
          state.captureTags.push(tag);
        }
      });
      
      renderTagsDisplay();
    });
    
    // Priority selector
    document.querySelectorAll('.priority-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const priority = btn.dataset.priority;
        
        document.querySelectorAll('.priority-btn').forEach(b => {
          b.classList.remove('active', 'critical', 'follow-up', 'pinned');
        });
        
        if (priority !== 'none') {
          btn.classList.add('active', priority);
          state.capturePriority = priority;
        } else {
          state.capturePriority = null;
        }
      });
    });
    
    document.getElementById('captureThreadSelect').addEventListener('change', (e) => {
      const threadId = e.target.value;
      state.selectedThread = threadId || null;
      render();
    });
    
    document.getElementById('createThreadFromCaptureBtn').addEventListener('click', () => {
      const name = prompt('Thread name:');
      if (!name) return;
      
      const newThread = {
        id: generateId(),
        name,
        created: Date.now(),
        momentIds: []
      };
      
      state.threads.unshift(newThread);
      state.selectedThread = newThread.id;
      saveData();
      render();
    });
    
    document.getElementById('codeModalCancelBtn').addEventListener('click', () => {
      document.getElementById('codeModal').classList.remove('visible');
    });
    
    document.getElementById('codeModalAddBtn').addEventListener('click', () => {
      const language = document.getElementById('modalCodeLanguage').value;
      const title = document.getElementById('modalCodeTitle').value.trim();
      const code = document.getElementById('modalCodeContent').value.trim();
      
      if (!code) {
        alert('Please enter some code');
        return;
      }
      
      const codeId = `code-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
      state.captureCodeBlocks.push({ language, code, title, id: codeId });
      
      const preview = document.getElementById('codePreview');
      preview.appendChild(createCodeBlock(language, code, title, codeId));
      
      document.getElementById('codeModal').classList.remove('visible');
    });
    
    window.editCodeBlock = function(codeId) {
      const codeIndex = state.captureCodeBlocks.findIndex(c => c.id === codeId);
      if (codeIndex === -1) return;
      
      const codeBlock = state.captureCodeBlocks[codeIndex];
      document.getElementById('modalCodeLanguage').value = codeBlock.language;
      document.getElementById('modalCodeTitle').value = codeBlock.title || '';
      document.getElementById('modalCodeContent').value = codeBlock.code;
      
      document.getElementById('codeModal').classList.add('visible');
      
      const codeElement = document.querySelector(`[data-code-id="${codeId}"]`);
      if (codeElement) {
        codeElement.remove();
      }
      state.captureCodeBlocks.splice(codeIndex, 1);
    };
    
    window.removeCodeBlock = function(codeId) {
      const codeIndex = state.captureCodeBlocks.findIndex(c => c.id === codeId);
      if (codeIndex !== -1) {
        state.captureCodeBlocks.splice(codeIndex, 1);
      }
      
      const codeElement = document.querySelector(`[data-code-id="${codeId}"]`);
      if (codeElement) {
        codeElement.remove();
      }
    };
    
    document.getElementById('addTableBtn').addEventListener('click', () => {
      document.getElementById('tableModal').classList.add('visible');
      document.getElementById('modalTableTitle').value = '';
      document.getElementById('modalTableContent').value = '';
    });
    
    document.getElementById('tableModalCancelBtn').addEventListener('click', () => {
      document.getElementById('tableModal').classList.remove('visible');
    });
    
    document.getElementById('tableModalAddBtn').addEventListener('click', () => {
      const title = document.getElementById('modalTableTitle').value.trim();
      const data = document.getElementById('modalTableContent').value.trim();
      
      if (!data) {
        alert('Please enter table data');
        return;
      }
      
      const tableId = `table-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
      state.captureTables.push({ title, data, id: tableId });
      
      const preview = document.getElementById('tablePreview');
      preview.appendChild(createTable(title, data, tableId));
      
      document.getElementById('tableModal').classList.remove('visible');
    });
    
    window.editTable = function(tableId) {
      const tableIndex = state.captureTables.findIndex(t => t.id === tableId);
      if (tableIndex === -1) return;
      
      const table = state.captureTables[tableIndex];
      document.getElementById('modalTableTitle').value = table.title || '';
      document.getElementById('modalTableContent').value = table.data;
      
      document.getElementById('tableModal').classList.add('visible');
      
      const tableElement = document.querySelector(`[data-table-id="${tableId}"]`);
      if (tableElement) {
        tableElement.remove();
      }
      state.captureTables.splice(tableIndex, 1);
    };
    
    window.removeTable = function(tableId) {
      const tableIndex = state.captureTables.findIndex(t => t.id === tableId);
      if (tableIndex !== -1) {
        state.captureTables.splice(tableIndex, 1);
      }
      
      const tableElement = document.querySelector(`[data-table-id="${tableId}"]`);
      if (tableElement) {
        tableElement.remove();
      }
    };
    
    document.getElementById('modalCancelBtn').addEventListener('click', () => {
      document.getElementById('chartModal').classList.remove('visible');
    });
    
    document.getElementById('modalAddBtn').addEventListener('click', () => {
      const title = document.getElementById('modalChartTitle').value.trim();
      const dataStr = document.getElementById('modalChartData').value.trim();
      const labelsStr = document.getElementById('modalChartLabels').value.trim();
      const chartType = document.getElementById('modalChartType').value;
      
      if (!title || !dataStr) {
        alert('Please enter a chart title and data points');
        return;
      }
      
      const data = dataStr.split(',').map(v => parseFloat(v.trim())).filter(v => !isNaN(v));
      if (data.length === 0) {
        alert('Please enter valid numeric data points');
        return;
      }
      
      const labels = labelsStr ? labelsStr.split(',').map(l => l.trim()) : null;
      
      const chartId = `chart-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
      state.captureCharts.push({ title, data, labels, chartType, id: chartId });
      
      const preview = document.getElementById('chartPreview');
      const config = MOMENT_TYPES[state.captureType];
      preview.appendChild(createChart(title, data, config.color, labels, chartId, chartType));
      
      document.getElementById('chartModal').classList.remove('visible');
    });
    
    document.getElementById('confirmCancelBtn').addEventListener('click', hideConfirmModal);
    
    document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
      if (confirmCallback) {
        confirmCallback();
      }
    });
    
    document.getElementById('chartModal').addEventListener('click', (e) => {
      if (e.target.id === 'chartModal') {
        document.getElementById('chartModal').classList.remove('visible');
      }
    });
    
    document.getElementById('codeModal').addEventListener('click', (e) => {
      if (e.target.id === 'codeModal') {
        document.getElementById('codeModal').classList.remove('visible');
      }
    });
    
    document.getElementById('tableModal').addEventListener('click', (e) => {
      if (e.target.id === 'tableModal') {
        document.getElementById('tableModal').classList.remove('visible');
      }
    });
    
    document.getElementById('confirmModal').addEventListener('click', (e) => {
      if (e.target.id === 'confirmModal') {
        hideConfirmModal();
      }
    });
    
    window.editChart = function(chartId) {
      const chartIndex = state.captureCharts.findIndex(c => c.id === chartId);
      if (chartIndex === -1) return;
      
      const chart = state.captureCharts[chartIndex];
      document.getElementById('modalChartTitle').value = chart.title || chart.type;
      document.getElementById('modalChartData').value = chart.data.join(', ');
      document.getElementById('modalChartLabels').value = chart.labels ? chart.labels.join(', ') : '';
      document.getElementById('modalChartType').value = chart.chartType || 'line';
      
      document.getElementById('chartModal').classList.add('visible');
      
      const chartElement = document.querySelector(`[data-chart-id="${chartId}"]`);
      if (chartElement) {
        chartElement.remove();
      }
      state.captureCharts.splice(chartIndex, 1);
    };
    
    window.removeChart = function(chartId) {
      const chartIndex = state.captureCharts.findIndex(c => c.id === chartId);
      if (chartIndex !== -1) {
        state.captureCharts.splice(chartIndex, 1);
      }
      
      const chartElement = document.querySelector(`[data-chart-id="${chartId}"]`);
      if (chartElement) {
        chartElement.remove();
      }
    };
    
    window.editMoment = function(momentId) {
      const moment = state.moments.find(m => m.id === momentId);
      if (!moment) return;
      
      state.editingMoment = moment;
      state.selectedThread = moment.threadId || null;
      
      state.captureType = moment.type;
      document.getElementById('captureText').value = moment.text;
      document.getElementById('contextService').value = moment.context.service || '';
      document.getElementById('contextEnvironment').value = moment.context.environment || 'production';
      document.getElementById('contextVersion').value = moment.context.version || '';
      
      document.querySelectorAll('.type-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.type === moment.type);
      });
      
      state.captureCharts = moment.charts ? JSON.parse(JSON.stringify(moment.charts)) : [];
      const chartPreview = document.getElementById('chartPreview');
      chartPreview.innerHTML = '';
      state.captureCharts.forEach(chart => {
        const config = MOMENT_TYPES[state.captureType];
        chartPreview.appendChild(createChart(
          chart.title || chart.type, 
          chart.data, 
          config.color, 
          chart.labels || null, 
          chart.id, 
          chart.chartType || 'line'
        ));
      });
      
      state.captureCodeBlocks = moment.codeBlocks ? JSON.parse(JSON.stringify(moment.codeBlocks)) : [];
      const codePreview = document.getElementById('codePreview');
      codePreview.innerHTML = '';
      state.captureCodeBlocks.forEach(codeBlock => {
        codePreview.appendChild(createCodeBlock(codeBlock.language, codeBlock.code, codeBlock.title || '', codeBlock.id));
      });
      
      state.captureTables = moment.tables ? JSON.parse(JSON.stringify(moment.tables)) : [];
      const tablePreview = document.getElementById('tablePreview');
      tablePreview.innerHTML = '';
      state.captureTables.forEach(table => {
        tablePreview.appendChild(createTable(table.title || '', table.data, table.id));
      });
      
      state.captureAttachments = moment.attachments ? JSON.parse(JSON.stringify(moment.attachments)) : [];
      const attachmentsPreview = document.getElementById('attachmentsPreview');
      attachmentsPreview.innerHTML = '';
      state.captureAttachments.forEach(attachment => {
        renderAttachmentPreview(attachment);
      });
      
      // Populate template fields
      renderTemplateFields(moment.type);
      if (moment.templateData) {
        setTimeout(() => {
          const container = document.getElementById('templateFieldsContainer');
          const inputs = container.querySelectorAll('[data-template-field]');
          inputs.forEach(input => {
            const fieldName = input.dataset.templateField;
            if (moment.templateData[fieldName]) {
              input.value = moment.templateData[fieldName];
            }
          });
        }, 100);
      }
      
      // Populate tags
      state.captureTags = moment.tags ? [...moment.tags] : [];
      renderTagsDisplay();
      
      // Populate priority
      state.capturePriority = moment.priority || null;
      document.querySelectorAll('.priority-btn').forEach(btn => {
        btn.classList.remove('active', 'critical', 'follow-up', 'pinned');
        if (moment.priority && btn.dataset.priority === moment.priority) {
          btn.classList.add('active', moment.priority);
        }
      });
      
      document.getElementById('submitCaptureBtn').innerHTML = '<svg class="icon-action" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg> Update Moment';
      state.view = 'capture';
      render();
    };
    
    window.clearThreadFilter = function() {
      state.selectedThread = null;
      render();
    };
    
    window.assignToThread = function(momentId, threadId) {
      const momentIndex = state.moments.findIndex(m => m.id === momentId);
      if (momentIndex === -1) return;
      
      if (threadId) {
        state.moments[momentIndex].threadId = threadId;
      } else {
        delete state.moments[momentIndex].threadId;
      }
      
      saveData();
      render();
    };
    
    window.removeFromThread = function(momentId) {
      const momentIndex = state.moments.findIndex(m => m.id === momentId);
      if (momentIndex === -1) return;
      
      delete state.moments[momentIndex].threadId;
      saveData();
      render();
    };
    
    let confirmCallback = null;
    
    function showConfirmModal(title, message, icon, onConfirm) {
      document.getElementById('confirmTitle').textContent = title;
      document.getElementById('confirmMessage').textContent = message;
      document.getElementById('confirmIcon').textContent = icon;
      confirmCallback = onConfirm;
      document.getElementById('confirmModal').classList.add('visible');
    }
    
    function hideConfirmModal() {
      document.getElementById('confirmModal').classList.remove('visible');
      confirmCallback = null;
    }
    
    window.confirmDeleteMoment = function(momentId) {
      const moment = state.moments.find(m => m.id === momentId);
      if (!moment) return;
      
      const config = MOMENT_TYPES[moment.type];
      showConfirmModal(
        'Delete Moment?',
        `Are you sure you want to delete this ${config.label.toLowerCase()}? This action cannot be undone.`,
        '<svg class="icon-action" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>',
        () => deleteMoment(momentId)
      );
    };
    
    function deleteMoment(momentId) {
      const momentIndex = state.moments.findIndex(m => m.id === momentId);
      if (momentIndex === -1) return;
      
      state.moments.splice(momentIndex, 1);
      state.selectedMoment = null;
      
      saveData();
      hideConfirmModal();
      render();
    }
    
    window.confirmDeleteThread = function() {
      if (!state.selectedThread) return;
      
      const thread = state.threads.find(t => t.id === state.selectedThread);
      if (!thread) return;
      
      const threadMoments = state.moments.filter(m => m.threadId === state.selectedThread);
      
      showConfirmModal(
        'Delete Thread?',
        `Are you sure you want to delete "${thread.name}"? This will remove the thread but keep all ${threadMoments.length} moment${threadMoments.length !== 1 ? 's' : ''} (they will become unthreaded).`,
        '<svg class="icon-context" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 17h.01"/><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/></svg>',
        () => deleteThread(state.selectedThread)
      );
    };
    
    function deleteThread(threadId) {
      const threadIndex = state.threads.findIndex(t => t.id === threadId);
      if (threadIndex === -1) return;
      
      state.moments.forEach(moment => {
        if (moment.threadId === threadId) {
          delete moment.threadId;
        }
      });
      
      state.threads.splice(threadIndex, 1);
      state.selectedThread = null;
      
      saveData();
      hideConfirmModal();
      render();
    }
    
    document.getElementById('cancelCaptureBtn').addEventListener('click', () => {
      state.view = 'timeline';
      state.captureText = '';
      state.captureCharts = [];
      state.captureCodeBlocks = [];
      state.captureTables = [];
      state.captureAttachments = [];
      state.captureTags = [];
      state.capturePriority = null;
      state.editingMoment = null;
      document.getElementById('captureText').value = '';
      document.getElementById('chartPreview').innerHTML = '';
      document.getElementById('codePreview').innerHTML = '';
      document.getElementById('tablePreview').innerHTML = '';
      document.getElementById('attachmentsPreview').innerHTML = '';
      document.getElementById('templateFieldsContainer').innerHTML = '';
      document.getElementById('templateFields').style.display = 'none';
      document.getElementById('tagsInput').value = '';
      document.getElementById('tagsDisplay').innerHTML = '';
      document.querySelectorAll('.priority-btn').forEach(b => b.classList.remove('active', 'critical', 'follow-up', 'pinned'));
      document.getElementById('submitCaptureBtn').innerHTML = '<svg class="icon-action" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg> Capture Moment';
      render();
    });
    
    
    function collectTemplateData() {
      const container = document.getElementById('templateFieldsContainer');
      const inputs = container.querySelectorAll('[data-template-field]');
      const templateData = {};
      
      inputs.forEach(input => {
        const fieldName = input.dataset.templateField;
        const value = input.value.trim();
        if (value) {
          templateData[fieldName] = value;
        }
      });
      
      return Object.keys(templateData).length > 0 ? templateData : null;
    }
    
    document.getElementById('submitCaptureBtn').addEventListener('click', () => {
      const text = document.getElementById('captureText').value.trim();
      if (!text) {
        alert('Please enter your thought');
        return;
      }
      
      const templateData = collectTemplateData();
      
      if (state.editingMoment) {
        const momentIndex = state.moments.findIndex(m => m.id === state.editingMoment.id);
        if (momentIndex !== -1) {
          state.moments[momentIndex] = {
            ...state.moments[momentIndex],
            type: state.captureType,
            text: text,
            context: {
              service: document.getElementById('contextService').value,
              environment: document.getElementById('contextEnvironment').value,
              version: document.getElementById('contextVersion').value
            },
            charts: state.captureCharts,
            codeBlocks: state.captureCodeBlocks,
            tables: state.captureTables,
            attachments: state.captureAttachments,
            templateData: templateData,
            tags: [...state.captureTags],
            priority: state.capturePriority
          };
          state.selectedMoment = state.moments[momentIndex];
        }
        state.editingMoment = null;
      } else {
        const newMoment = {
          id: generateId(),
          type: state.captureType,
          text: text,
          timestamp: Date.now(),
          context: {
            service: document.getElementById('contextService').value,
            environment: document.getElementById('contextEnvironment').value,
            version: document.getElementById('contextVersion').value
          },
          charts: state.captureCharts,
          codeBlocks: state.captureCodeBlocks,
          tables: state.captureTables,
          attachments: state.captureAttachments,
          templateData: templateData,
          tags: [...state.captureTags],
          priority: state.capturePriority,
          threadId: state.selectedThread
        };
        
        state.moments.unshift(newMoment);
        state.selectedMoment = newMoment;
      }
      
      state.view = 'timeline';
      state.captureText = '';
      state.captureCharts = [];
      state.captureCodeBlocks = [];
      state.captureTables = [];
      state.captureAttachments = [];
      state.captureTags = [];
      state.capturePriority = null;
      
      document.getElementById('captureText').value = '';
      document.getElementById('contextService').value = '';
      document.getElementById('contextEnvironment').value = 'production';
      document.getElementById('contextVersion').value = '';
      document.getElementById('chartPreview').innerHTML = '';
      document.getElementById('codePreview').innerHTML = '';
      document.getElementById('tablePreview').innerHTML = '';
      document.getElementById('attachmentsPreview').innerHTML = '';
      document.getElementById('templateFieldsContainer').innerHTML = '';
      document.getElementById('templateFields').style.display = 'none';
      document.getElementById('tagsInput').value = '';
      document.getElementById('tagsDisplay').innerHTML = '';
      document.querySelectorAll('.priority-btn').forEach(b => b.classList.remove('active', 'critical', 'follow-up', 'pinned'));
      document.getElementById('submitCaptureBtn').innerHTML = '<svg class="icon-action" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg> Capture Moment';
      
      saveData();
      render();
    });
    
    document.getElementById('searchInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        performSearch();
      }
    });
    
    document.getElementById('searchInput').addEventListener('input', (e) => {
      const query = e.target.value.trim();
      if (!query) {
        // Clear search results when search box is empty
        state.searchResults = [];
        const resultsContainer = document.getElementById('searchResults');
        resultsContainer.innerHTML = '';
      }
    });
    
    document.getElementById('searchBtn').addEventListener('click', performSearch);
    
    async function performSearch() {
      const query = document.getElementById('searchInput').value.trim();
      if (!query) return;
      
      const btn = document.getElementById('searchBtn');
      btn.disabled = true;
      btn.textContent = ' Searching...';
      
      const resultsContainer = document.getElementById('searchResults');
      
      try {
        const response = await fetch("https://api.anthropic.com/v1/messages", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            model: "claude-sonnet-4-20250514",
            max_tokens: 1000,
            messages: [{
              role: "user",
              content: `You are a semantic search engine for developer notes. Given this search query and list of moments, return the IDs of relevant moments ranked by relevance. Only return a JSON array of IDs, nothing else.

Search query: "${query}"

Moments:
${state.moments.map(m => `ID: ${m.id}\nType: ${m.type}\nText: ${m.text}\nContext: ${JSON.stringify(m.context)}\nTags: ${m.tags ? m.tags.join(', ') : 'none'}\nPriority: ${m.priority || 'none'}\n`).join('\n---\n')}

Return only: ["id1", "id2", ...]`
            }]
          })
        });
        
        const data = await response.json();
        const text = data.content.find(c => c.type === 'text')?.text || '[]';
        const cleanText = text.replace(/```json|```/g, '').trim();
        const ids = JSON.parse(cleanText);
        
        state.searchResults = ids
          .map(id => state.moments.find(m => m.id === id))
          .filter(Boolean);
        
      } catch (error) {
        console.error('Search failed:', error);
        const lowerQuery = query.toLowerCase();
        
        state.searchResults = state.moments.filter(m => {
          // Text search
          if (m.text.toLowerCase().includes(lowerQuery)) return true;
          
          // Context search
          if (m.context.service?.toLowerCase().includes(lowerQuery)) return true;
          if (m.context.environment?.toLowerCase().includes(lowerQuery)) return true;
          if (m.context.version?.toLowerCase().includes(lowerQuery)) return true;
          
          // Tag search - support both #tag and tag format
          if (m.tags && m.tags.length > 0) {
            const searchTag = lowerQuery.replace(/^#/, ''); // Remove # if present
            if (m.tags.some(tag => tag.toLowerCase().includes(searchTag))) return true;
          }
          
          // Priority search
          if (m.priority) {
            const priorityLabels = {
              critical: ['critical', 'urgent', 'high priority', ''],
              'follow-up': ['follow-up', 'follow up', 'followup', 'todo', ''],
              pinned: ['pinned', 'starred', 'star', 'important', '']
            };
            
            if (priorityLabels[m.priority].some(label => lowerQuery.includes(label))) return true;
          }
          
          return false;
        });
      }
      
      btn.disabled = false;
      btn.textContent = ' Search';
      
      if (state.searchResults.length > 0) {
        resultsContainer.innerHTML = `<div class="results-header">Found ${state.searchResults.length} relevant moment${state.searchResults.length !== 1 ? 's' : ''}</div>`;
        const momentsContainer = document.createElement('div');
        
        state.searchResults.forEach(moment => {
          const config = MOMENT_TYPES[moment.type];
          const card = document.createElement('div');
          card.className = 'moment-card';
          card.style.borderLeftColor = config.color;
          
          let contextHtml = '';
          if (moment.context.service || moment.context.environment) {
            contextHtml = '<div class="moment-context">';
            if (moment.context.service) contextHtml += `<div class="context-tag"><svg class="icon-context" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg> ${moment.context.service}</div>`;
            if (moment.context.environment) contextHtml += `<div class="context-tag"><svg class="icon-context" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg> ${moment.context.environment}</div>`;
            contextHtml += '</div>';
          }
          
          let priorityHtml = '';
          if (moment.priority) {
            const priorityIcons = { critical: `<svg class="icon-priority" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10" fill="#E0115F"/></svg>`, 'follow-up': `<svg class="icon-priority" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10" fill="#ff922b"/></svg>`, pinned: `<svg class="icon-priority" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" fill="#ffd700"/></svg>` };
            const priorityLabels = { critical: 'Critical', 'follow-up': 'Follow-up', pinned: 'Pinned' };
            priorityHtml = `<div class="moment-priority"><span class="priority-badge ${moment.priority}">${priorityIcons[moment.priority]} ${priorityLabels[moment.priority]}</span></div>`;
          }
          
          card.innerHTML = `
            ${priorityHtml}
            <div class="moment-header">
              <div class="moment-type" style="color: ${config.color}">
                ${config.icon} ${config.label}
              </div>
              <div class="moment-time">${formatTime(moment.timestamp)}</div>
            </div>
            <div class="moment-text">${parseMarkdown(moment.text)}</div>
            ${contextHtml}
          `;
          
          if (moment.tags && moment.tags.length > 0) {
            const tagsContainer = document.createElement('div');
            tagsContainer.className = 'moment-tags';
            moment.tags.forEach(tag => {
              const tagEl = document.createElement('span');
              tagEl.className = 'moment-tag';
              tagEl.textContent = '#' + tag;
              tagEl.style.cursor = 'default';
              tagsContainer.appendChild(tagEl);
            });
            card.appendChild(tagsContainer);
          }
          
          card.addEventListener('click', () => {
            state.selectedMoment = moment;
            state.view = 'timeline';
            render();
          });
          
          momentsContainer.appendChild(card);
        });
        
        resultsContainer.appendChild(momentsContainer);
      } else {
        resultsContainer.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon"></div>
            <h3>No results found</h3>
            <p>Try a different search query</p>
          </div>
        `;
      }
    }
    
    
    function showImageModal(imageData) {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay visible';
      modal.innerHTML = `
        <div class="modal modal-wide" style="max-width: 90vw; max-height: 90vh; padding: 0; overflow: hidden;">
          <img src="${imageData}" style="width: 100%; height: 100%; object-fit: contain; display: block;">
        </div>
      `;
      
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          document.body.removeChild(modal);
        }
      });
      
      document.body.appendChild(modal);
    }
    
    function downloadAttachment(attachment) {
      const link = document.createElement('a');
      link.href = attachment.data;
      link.download = attachment.name;
      link.click();
    }
    
    // Initialize
    loadData();
  </script>
</body>
</html>
